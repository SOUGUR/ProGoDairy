<!DOCTYPE html>
<html>
<head>
  <title>Payment Bills</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f9fc;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      padding: 30px;
    }
    
    h1 {
      color: #2c5282;
      margin-bottom: 25px;
      font-weight: 600;
      border-bottom: 2px solid #ebf2f7;
      padding-bottom: 10px;
    }
    
    .filter-section {
      background-color: #ebf8ff;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }
    
    .filter-title {
      color: #2b6cb0;
      margin-bottom: 15px;
      font-weight: 600;
    }
    
    .filter-form {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      align-items: flex-end;
    }
    
    .form-group {
      margin-bottom: 0;
      flex: 1;
      min-width: 200px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #4a5568;
    }
    
    select, input {
      width: 100%;
      padding: 12px;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      font-size: 16px;
      transition: border-color 0.3s;
      box-sizing: border-box;
    }
    
    select:focus, input:focus {
      border-color: #63b3ed;
      outline: none;
      box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.2);
    }
    
    .btn {
      background-color: #4299e1;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s;
      height: 44px;
    }
    
    .btn:hover {
      background-color: #3182ce;
    }
    
    .payment-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    .payment-table thead {
      background-color: #ebf8ff;
      color: #2b6cb0;
    }
    
    .payment-table th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85em;
      letter-spacing: 0.5px;
    }
    
    .payment-table td {
      padding: 15px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .payment-table tr:nth-child(even) {
      background-color: #f8fafc;
    }
    
    .payment-table tr:hover {
      background-color: #ebf8ff;
    }
    
    .paid-status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.85em;
      font-weight: 500;
    }
    
    .paid-true {
      background-color: #c6f6d5;
      color: #22543d;
    }
    
    .paid-false {
      background-color: #fed7d7;
      color: #742a2a;
    }
    
    .price-cell {
      font-weight: 600;
      color: #2b6cb0;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    
    .btn-action {
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 0.85em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-view {
      background-color: #4299e1;
      color: white;
    }
    
    .btn-view:hover {
      background-color: #3182ce;
    }
    
    .btn-pdf {
      background-color: #e53e3e;
      color: white;
    }
    
    .btn-pdf:hover {
      background-color: #c53030;
    }
    
    .btn-mark-paid {
      background-color: #38a169;
      color: white;
    }
    
    .btn-mark-paid:hover {
      background-color: #2f855a;
    }
    
    .empty-state {
      text-align: center;
      padding: 30px;
      color: #718096;
      background-color: #f8fafc;
      border-radius: 4px;
    }
    
    .messages {
      list-style: none;
      padding: 0;
      margin: 1em 0;
      }
      .message {
        padding: 10px 15px;
        border-radius: 4px;
        margin-bottom: 10px;
        font-weight: 600;
        color: white;
      }
      .message.success {
        background-color: #4CAF50; 
      }
      .message.error {
        background-color: #f44336; 
      }
      .message.warning {
        background-color: #ff9800; 
      }
      .message.info {
        background-color: #2196F3; 
      }

    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.6); /* semi-transparent background */
    }

    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border-radius: 10px;
      width: 50%;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .close {
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }

  </style>
</head>
<body>
  {% if messages %}
  <ul class="messages">
    {% for message in messages %}
      <li class="message {{ message.tags }}">{{ message }}</li>
    {% endfor %}
  </ul>
  {% endif %}

  <div class="container">
    <h1>Payment Bills</h1>
    
    <div class="filter-section">
      <h3 class="filter-title">Generate New Bill</h3>
      <form class="filter-form" method="GET" action="/generate-payment-bill/">
        <div class="form-group">
          <label for="supplier">Supplier</label>
          <select id="supplier" name="supplier_id" required>
            <option value="">Select Supplier</option>
            {% for supplier in suppliers %}
            <option value="{{ supplier.id }}">{{ supplier.user.username }} {{ supplier.email }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="form-group">
          <label for="start_date">Collection Date</label>
          <input type="date" id="start_date" name="start_date" required>
        </div>
        
        
        <button type="submit" class="btn">Generate Bill</button>
      </form>
    </div>
    
    <table class="payment-table">
      <thead>
        <tr>
          <th>Bill ID</th>
          <th>Date</th>
          <th>Supplier</th>
          <th>Volume (L)</th>
          <th>Total Value</th>
          <th>Status</th>
          <th>Payment Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for bill in payment_bills %}
        <tr>
          <td>{{ bill.id }}</td>
          <td>{{ bill.date }}</td>
          <td>{{ bill.supplier.id }}<br><small>{{ bill.supplier.email }}</small></td>
          <td>{{ bill.totalVolumeL }} L</td>
          <td class="price-cell">₹{{ bill.totalValue }}</td>
          <td>
            <span class="paid-status paid-{{ bill.isPaid|lower }}">
              {% if bill.isPaid %}Paid{% else %}Pending{% endif %}
            </span>
          </td>
          <td>{% if bill.paymentDate %}{{ bill.paymentDate }}{% else %}—{% endif %}</td>
          <td>
            <div class="action-buttons">
              <a href="#" class="btn-action btn-view" onclick="viewPaymentBill('{{ bill.id }}')">View</a>

              {% if bill.pdfUrl %}
                <a href="{{ bill.pdfUrl }}" class="btn-action btn-pdf">PDF</a>
              {% endif %}
              {% if not bill.isPaid %}
                <a href="#" class="btn-action btn-mark-paid" onclick="markBillPaid('{{ bill.id }}', '{{ bill.supplier.id }}', '{{ bill.date }}')">Mark Paid</a>
              {% endif %}
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="empty-state">No payment bills found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div id="paymentBillModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span onclick="document.getElementById('paymentBillModal').style.display='none'" class="close">&times;</span>
      <h2>Payment Bill Details</h2>
      <p><strong>ID:</strong> <span id="modal-id"></span></p>
      <p><strong>Date:</strong> <span id="modal-date"></span></p>
      <p><strong>Total Volume:</strong> <span id="modal-volume"></span></p>
      <p><strong>Total Value:</strong> <span id="modal-value"></span></p>
      <p><strong>Paid:</strong> <span id="modal-paid"></span></p>
      <p><strong>Payment Date:</strong> <span id="modal-payment-date"></span></p>
      <p><strong>Supplier Email:</strong> <span id="modal-supplier-email"></span></p>
    </div>
</div>
</div>
  </div>
  <script>
    function handlePaymentBillGeneration(event) {
    event.preventDefault(); 
    
    const form = event.target;
    const formData = new FormData(form);
    const supplierId = formData.get('supplier_id');
    const startDate = formData.get('start_date');
    
  
    if (!supplierId || !startDate) {
        alert('Please select both supplier and collection date');
        return;
    }


    const requestData = {
        supplier_id: supplierId,
        date: startDate
    };

    const submitBtn = form.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.textContent;
    submitBtn.textContent = 'Generating...';
    submitBtn.disabled = true;


    fetch('/create-Payment-Bill/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'), 
        },
        body: JSON.stringify(requestData),
        credentials: 'include'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.text();;
    })
    .then(html => {
    console.log('HTML response:', html);
  })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to create payment bill. Please try again.');
    })
    .finally(() => {
        submitBtn.textContent = originalBtnText;
        submitBtn.disabled = false;
    });
}
function markBillPaid(billId, supplierId, billDate) {
    const data = {
        supplier_id: supplierId,
        date: billDate,
        is_paid: true,
        payment_date: new Date().toISOString().slice(0, 10)  
    };

    fetch('/create-Payment-Bill/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data),
        credentials: 'include'
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;  // Django redirects to success page
        } else {
            return response.text().then(html => {
                document.body.innerHTML = html;  // Fallback: replace page content
            });
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Failed to mark bill as paid.");
    });
}
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
document.querySelector('.filter-form').addEventListener('submit', handlePaymentBillGeneration);
function viewPaymentBill(billId) {
    fetch(`/payment-bill/${billId}/`, {
        method: 'GET',
        credentials: 'include'
    })
    .then(response => response.json())
    .then(data => {
        const bill = data.bill;
        if (!bill) {
            alert("No bill found.");
            return;
        }

        // Now fill modal/dialog content
        document.getElementById('modal-id').textContent = bill.id;
        document.getElementById('modal-date').textContent = bill.date;
        document.getElementById('modal-volume').textContent = bill.totalVolumeL + ' L';
        document.getElementById('modal-value').textContent = '₹' + bill.totalValue;
        document.getElementById('modal-paid').textContent = bill.isPaid ? 'Paid' : 'Pending';
        document.getElementById('modal-payment-date').textContent = bill.paymentDate || '—';
        document.getElementById('modal-supplier-email').textContent = bill.supplier.email;

        // Show modal
        document.getElementById('paymentBillModal').style.display = 'block';
    })
    .catch(error => {
        console.error('Error fetching bill details:', error);
    });
}
function closeModal() {
    document.getElementById('billModal').style.display = 'none';
}
</script>
</body>
</html>