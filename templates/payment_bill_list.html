<!DOCTYPE html>
<html>
<head>
  <title>Payment Bills</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f9fc;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      padding: 30px;
    }
    
    h1 {
      color: #2c5282;
      margin-bottom: 25px;
      font-weight: 600;
      border-bottom: 2px solid #ebf2f7;
      padding-bottom: 10px;
    }
    
    .filter-section {
      background-color: #ebf8ff;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }
    
    .filter-title {
      color: #2b6cb0;
      margin-bottom: 15px;
      font-weight: 600;
    }
    
    .filter-form {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      align-items: flex-end;
    }
    
    .form-group {
      margin-bottom: 0;
      flex: 1;
      min-width: 200px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #4a5568;
    }
    
    select, input {
      width: 100%;
      padding: 12px;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      font-size: 16px;
      transition: border-color 0.3s;
      box-sizing: border-box;
    }
    
    select:focus, input:focus {
      border-color: #63b3ed;
      outline: none;
      box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.2);
    }
    
    .btn {
      background-color: #4299e1;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.3s;
      height: 44px;
    }
    
    .btn:hover {
      background-color: #3182ce;
    }
    
    .payment-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    .payment-table thead {
      background-color: #ebf8ff;
      color: #2b6cb0;
    }
    
    .payment-table th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85em;
      letter-spacing: 0.5px;
    }
    
    .payment-table td {
      padding: 15px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .payment-table tr:nth-child(even) {
      background-color: #f8fafc;
    }
    
    .payment-table tr:hover {
      background-color: #ebf8ff;
    }
    
    .paid-status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.85em;
      font-weight: 500;
    }
    
    .paid-true {
      background-color: #c6f6d5;
      color: #22543d;
    }
    
    .paid-false {
      background-color: #fed7d7;
      color: #742a2a;
    }
    
    .price-cell {
      font-weight: 600;
      color: #2b6cb0;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    
    .btn-action {
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 0.85em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .btn-view {
      background-color: #4299e1;
      color: white;
    }
    
    .btn-view:hover {
      background-color: #3182ce;
    }
    
    .btn-pdf {
      background-color: #e53e3e;
      color: white;
    }
    
    .btn-pdf:hover {
      background-color: #c53030;
    }
    
    .btn-mark-paid {
      background-color: #38a169;
      color: white;
    }
    
    .btn-mark-paid:hover {
      background-color: #2f855a;
    }
    
    .empty-state {
      text-align: center;
      padding: 30px;
      color: #718096;
      background-color: #f8fafc;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Payment Bills</h1>
    
    <div class="filter-section">
      <h3 class="filter-title">Generate New Bill</h3>
      <form class="filter-form" method="GET" action="/generate-payment-bill/">
        <div class="form-group">
          <label for="supplier">Supplier</label>
          <select id="supplier" name="supplier_id" required>
            <option value="">Select Supplier</option>
            {% for supplier in suppliers %}
            <option value="{{ supplier.id }}">{{ supplier.user.username }} {{ supplier.email }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="form-group">
          <label for="start_date">Collection Date</label>
          <input type="date" id="start_date" name="start_date" required>
        </div>
        
        
        <button type="submit" class="btn">Generate Bill</button>
      </form>
    </div>
    
    <table class="payment-table">
      <thead>
        <tr>
          <th>Bill ID</th>
          <th>Date</th>
          <th>Supplier</th>
          <th>Volume (L)</th>
          <th>Total Value</th>
          <th>Status</th>
          <th>Payment Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for bill in payment_bills %}
        <tr>
          <td>{{ bill.id }}</td>
          <td>{{ bill.date }}</td>
          <td>{{ bill.supplier.user.username }}<br><small>{{ bill.supplier.user.email }}</small></td>
          <td>{{ bill.totalVolumeL }} L</td>
          <td class="price-cell">₹{{ bill.totalValue }}</td>
          <td>
            <span class="paid-status paid-{{ bill.isPaid|lower }}">
              {% if bill.isPaid %}Paid{% else %}Pending{% endif %}
            </span>
          </td>
          <td>{% if bill.paymentDate %}{{ bill.paymentDate }}{% else %}—{% endif %}</td>
          <td>
            <div class="action-buttons">
              <a href="/payment-bills/{{ bill.id }}" class="btn-action btn-view">View</a>
              {% if bill.pdfUrl %}
                <a href="{{ bill.pdfUrl }}" class="btn-action btn-pdf">PDF</a>
              {% endif %}
              {% if not bill.isPaid %}
                <a href="/payment-bills/{{ bill.id }}/mark-paid" class="btn-action btn-mark-paid">Mark Paid</a>
              {% endif %}
            </div>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" class="empty-state">No payment bills found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <script>
    function handlePaymentBillGeneration(event) {
    event.preventDefault(); // Prevent default form submission
    
    const form = event.target;
    const formData = new FormData(form);
    const supplierId = formData.get('supplier_id');
    const startDate = formData.get('start_date');
    
    // Basic validation
    if (!supplierId || !startDate) {
        alert('Please select both supplier and collection date');
        return;
    }

    // Prepare the request data
    const requestData = {
        supplier_id: supplierId,
        date: startDate
    };

    // Show loading state
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.textContent;
    submitBtn.textContent = 'Generating...';
    submitBtn.disabled = true;

    // Make the AJAX request
    fetch('/create-Payment-Bill/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'), // Ensure CSRF token is included
        },
        body: JSON.stringify(requestData),
        credentials: 'include' // Include cookies for session
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Reload the page to show the new bill
            window.location.reload();
        } else {
            alert('Error creating payment bill: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to create payment bill. Please try again.');
    })
    .finally(() => {
        // Restore button state
        submitBtn.textContent = originalBtnText;
        submitBtn.disabled = false;
    });
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Attach the event listener to the form
document.querySelector('.filter-form').addEventListener('submit', handlePaymentBillGeneration);
  </script>
</body>
</html>