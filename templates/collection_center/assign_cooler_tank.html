{% extends "base.html" %}

{% block title %}Assign Bulk Cooler to Milk Lots{% endblock %}

{% block content %}
<div class="container">
  <h1>Bulk Cooler Management</h1>
  
  <!-- Cooler Selection Card -->
  <div class="cooler-selection-card">
    <div class="section-title">Cooler Details</div>
    
    <div class="cooler-form-grid">
      <!-- Route and Cooler Selection -->
      <div class="form-group">
        <label for="route">Route</label>
        <select id="route" name="route" required>
          <option value="">Select Route</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="cooler">Bulk Cooler</label>
        <select id="cooler" name="cooler" required>
          <option value="">Select Bulk Cooler</option>
        </select>
      </div>
      
      <!-- Capacity Display -->
      <div class="capacity-display">
        <div class="capacity-item">
          <span>Total Capacity:</span>
          <strong id="total-capacity">0</strong> L
        </div>
        <div class="capacity-item">
          <span>Current Volume:</span>
          <strong id="current-volume">0</strong> L
        </div>
        <div class="capacity-item">
          <span>Available Space:</span>
          <strong id="available-space">0</strong> L
        </div>
      </div>
      
      <!-- Cooler Status Fields -->
      <div class="form-group">
        <label for="temperature">Temperature (Â°C)</label>
        <input type="number" id="temperature" name="temperature_celsius" 
               step="0.1" min="0" max="8" value="4.0" required>
      </div>
      
      
      <!-- Maintenance Fields -->
      <div class="form-group">
        <label for="last_cleaned">Last Cleaned At</label>
        <input type="datetime-local" id="last_cleaned" name="last_cleaned_at">
      </div>
      
      <div class="form-group">
        <label for="last_sanitized">Last Sanitized At</label>
        <input type="datetime-local" id="last_sanitized" name="last_sanitized_at">
      </div>
      
      <div class="form-group">
        <label for="last_calibrated">Last Calibrated At</label>
        <input type="datetime-local" id="last_calibrated" name="last_calibration_date">
      </div>
      
      <div class="form-group">
        <label for="service_interval">Service Interval (days)</label>
        <input type="number" id="service_interval" name="service_interval_days" 
               min="1" value="90">
      </div>
      
      <div class="form-group">
        <label for="last_serviced">Last Serviced At</label>
        <input type="datetime-local" id="last_serviced" name="last_serviced_at">
      </div>
    </div>
  </div>
  
  <!-- Milk Lots Assignment Section -->
  <div class="milk-lots-section">
    <div class="section-header">
      <h2>Approved Milk Lots</h2>
      <div class="selection-info">
        <span>Selected Volume: </span>
        <strong id="selected-volume">0</strong> L
      </div>
    </div>
    
    <div class="select-all-container">
      <input type="checkbox" id="select-all">
      <label for="select-all">Select all unassigned lots</label>
    </div>
    
    <table class="milk-lots-table">
      <thead>
        <tr>
          <th>MilkLot ID</th>
          <th>Supplier</th>
          <th>Date created</th>
          <th>Volume (L)</th>
          <th>Fat %</th>
          <th>Protein %</th>
          <th>added water %</th>
          <th>Status</th>
          <th>Assigned To</th>
          <th>Select</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    
    <div class="action-buttons">
      <button type="button" class="btn btn-primary" id="assign-btn">
        Assign Selected to Cooler
      </button>
    </div>
  </div>
</div>

<script>

//--------------------------------------------------populate routes and associated Bulk Coolers---------------------------------------------//
document.addEventListener("DOMContentLoaded", async () => {
  const routeSelect = document.getElementById("route");
  const coolerSelect = document.getElementById("cooler");

  const totalCapacityEl = document.getElementById("total-capacity");
  const currentVolumeEl = document.getElementById("current-volume");
  const availableSpaceEl = document.getElementById("available-space");

  let coolersCache = []; // Store the coolers for the selected route

  // Fetch all routes first
  try {
    const routeQuery = `
      query {
        allRoutes {
          id
          name
        }
      }
    `;
    const routeRes = await fetch("/graphql/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ query: routeQuery })
    });

    const routeData = await routeRes.json();
    const routes = routeData.data.allRoutes || [];

    routeSelect.innerHTML = '<option value="">Select Route</option>';
    routes.forEach(route => {
      const option = document.createElement("option");
      option.value = route.id;
      option.textContent = route.name;
      routeSelect.appendChild(option);
    });
  } catch (error) {
    console.error("Error fetching routes:", error);
  }

  // When route changes, fetch coolers consequently
  routeSelect.addEventListener("change", async function () {
    const routeId = this.value;
    coolerSelect.innerHTML = '<option value="">Select Bulk Cooler</option>';
    if (!routeId) return;

    try {
      const coolerQuery = `
        query GetCoolers($routeId: Int!) {
          bulkCoolersByRoute(routeId: $routeId) {
            id
            name
            capacityLiters
            currentVolumeLiters
            route {
              name
            }
          }
        }
      `;
      const coolerRes = await fetch("/graphql/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          query: coolerQuery,
          variables: { routeId: parseInt(routeId) }
        })
      });

      const coolerData = await coolerRes.json();
      coolersCache = coolerData.data.bulkCoolersByRoute || [];

      coolersCache.forEach(cooler => {
        const option = document.createElement("option");
        option.value = cooler.id;
        option.textContent = `${cooler.name} (${cooler.route.name})`;
        coolerSelect.appendChild(option);
      });
    } catch (error) {
      console.error("Error fetching coolers:", error);
    }
  });

  coolerSelect.addEventListener("change", function () {
    const selectedCooler = coolersCache.find(c => c.id === parseInt(this.value));
    if (selectedCooler) {
      const totalCapacity = selectedCooler.capacityLiters;
      const currentVolume = selectedCooler.currentVolumeLiters;
      const availableSpace = totalCapacity - currentVolume;

      totalCapacityEl.textContent = totalCapacity;
      currentVolumeEl.textContent = currentVolume;
      availableSpaceEl.textContent = availableSpace;
    } else {
      totalCapacityEl.textContent = "0";
      currentVolumeEl.textContent = "0";
      availableSpaceEl.textContent = "0";
    }
  });
});



//-------------------------------------------------------populate the Milk Lot Table with APPROVED Milk Lots------------------------------//
document.addEventListener("DOMContentLoaded", async () => {
  const tableBody = document.querySelector(".milk-lots-table tbody");
  const totalVolumeSpan = document.getElementById("selected-volume");
  let totalVolume = 0;

  // GraphQL query to fetch approved Milk Lots
  const query = `
    query {
      approvedMilkLotList {
        id
        dateCreated
        supplier {
          user {
            username
          }
        }
        volumeL
        fatPercent
        proteinPercent
        addedWaterPercent
        status
        bulkCooler {
          id
          name
        }
        onFarmTank{
          id
          name
        }
        canCollection{
          id
          name
        }
      }
    }
  `;

  try {
    const res = await fetch("/graphql/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken")
      },
      body: JSON.stringify({ query })
    });

    const data = await res.json();
    const lots = data.data?.approvedMilkLotList || [];

    tableBody.innerHTML = "";

    if (lots.length === 0) {
      const emptyRow = document.createElement("tr");
      emptyRow.innerHTML = `<td colspan="8" class="empty-message">No approved milk lots available</td>`;
      tableBody.appendChild(emptyRow);
      return;
    }

    lots.forEach(lot => {
      const row = document.createElement("tr");

      row.innerHTML = `
        <td>${lot.id}</td>
        <td>${lot.supplier.user.username}</td>
        <td>${lot.dateCreated}</td>
        <td>${lot.volumeL}</td>
        <td>${lot.fatPercent}%</td>
        <td>${lot.proteinPercent}%</td>
        <td>${lot.addedWaterPercent}%</td>
        <td class="status-${lot.status.toLowerCase()}">${lot.status}</td>
        <td>
          ${lot.onFarmTank ? lot.onFarmTank.name : lot.bulkCooler ? lot.bulkCooler.name : lot.canCollection ? lot.canCollection.name : '<span class="unassigned">Unassigned</span>'}
        </td>
        <td>
          <input type="checkbox"
                name="selected_lots"
                value="${lot.id}"
                data-volume="${lot.volumeL}"
                ${(lot.onFarmTank || lot.bulkCooler || lot.canCollection) ? "disabled" : ""}>
        </td>

      `;
      tableBody.appendChild(row);
    });

    document.querySelectorAll('input[type="checkbox"][data-volume]').forEach(checkbox => {
      checkbox.addEventListener("change", function () {
        const volume = parseFloat(this.getAttribute("data-volume")) || 0;
        totalVolume += this.checked ? volume : -volume;
        updateTotalVolume();
      });
    });

    function updateTotalVolume() {
      totalVolumeSpan.textContent = totalVolume.toFixed(2);
    }

  } catch (error) {
    console.error("Error fetching milk lots:", error);
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});

// -----------------------------------------------------assign milk lots to Bulk Cooler -------------------------------------------------//
document.addEventListener("DOMContentLoaded", () => {
  const assignBtn = document.getElementById("assign-btn");

  assignBtn.addEventListener("click", async () => {
    const coolerId = parseInt(document.getElementById("cooler").value);
    if (!coolerId) {
      alert("Please select a bulk cooler first.");
      return;
    }

   
    const selectedLotIds = Array.from(
      document.querySelectorAll('input[name="selected_lots"]:checked')
    ).map(cb => parseInt(cb.value));

    if (selectedLotIds.length === 0) {
      alert("Please select at least one milk lot.");
      return;
    }

    const temperature = parseFloat(document.getElementById("temperature").value);
    const lastCleaned = document.getElementById("last_cleaned").value || null;
    const lastSanitized = document.getElementById("last_sanitized").value || null;
    const lastCalibrated = document.getElementById("last_calibrated").value || null;
    const serviceInterval = parseInt(document.getElementById("service_interval").value) || null;
    const lastServiced = document.getElementById("last_serviced").value || null;

    const mutation = `
      mutation AssignLots(
        $bulkCoolerId: Int!,
        $milkLotIds: [Int!]!,
        $temperature: Float!,
        $lastCleaned: DateTime,
        $lastSanitized: DateTime,
        $lastCalibrated: DateTime,
        $serviceInterval: Int,
        $lastServiced: DateTime
      ) {
        assignMilkLotsToCooler(
          bulkCoolerId: $bulkCoolerId,
          milkLotIds: $milkLotIds,
          temperatureCelsius: $temperature,
          lastCleanedAt: $lastCleaned,
          lastSanitizedAt: $lastSanitized,
          lastCalibrationDate: $lastCalibrated,
          serviceIntervalDays: $serviceInterval,
          lastServicedAt: $lastServiced
        ) {
          success
          message
        }
      }
    `;

    try {
      const res = await fetch("/graphql/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          query: mutation,
          variables: {
            bulkCoolerId: coolerId,
            milkLotIds: selectedLotIds,
            temperature: temperature,
            lastCleaned: lastCleaned || null,
            lastSanitized: lastSanitized || null,
            lastCalibrated: lastCalibrated || null,
            serviceInterval: serviceInterval,
            lastServiced: lastServiced || null
          }
        })
      });

      const data = await res.json();
      if (data.errors) {
        alert("Error: " + data.errors[0].message);
      } else {
        alert(data.data.assignMilkLotsToCooler.message);
        location.reload();
      }
    } catch (err) {
      console.error("Mutation error:", err);
      alert("Something went wrong.");
    }
  });
});

</script>

<style>
  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
  }
  
  .cooler-selection-card {
    background-color: #ebf8ff;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 30px;
  }
  
  .section-title {
    color: #2b6cb0;
    font-weight: 600;
    margin-bottom: 20px;
    font-size: 1.2em;
  }
  
  .cooler-form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
  }
  
  .form-group {
    margin-bottom: 15px;
  }
  
  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #4a5568;
  }
  
  select, input {
    width: 100%;
    padding: 10px;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    font-size: 16px;
  }
  
  .capacity-display {
    display: flex;
    gap: 20px;
    padding: 15px;
    background-color: #f0fff4;
    border-radius: 8px;
    margin: 15px 0;
    grid-column: 1 / -1;
  }
  
  .capacity-item {
    flex: 1;
    text-align: center;
  }
  
  .milk-lots-section {
    background-color: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  
  .selection-info {
    font-size: 1.1em;
  }
  
  .select-all-container {
    margin-bottom: 15px;
  }
  
  .milk-lots-table {
    width: 100%;
    border-collapse: collapse;
  }
  
  .milk-lots-table th {
    background-color: #ebf8ff;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: #2b6cb0;
  }
  
  .milk-lots-table td {
    padding: 12px;
    border-bottom: 1px solid #e2e8f0;
  }
  
  .milk-lots-table tr:nth-child(even) {
    background-color: #f8fafc;
  }
  
  .status-approved {
    color: #38a169;
    font-weight: 500;
  }
  
  .status-pending {
    color: #d69e2e;
    font-weight: 500;
  }
  
  .unassigned {
    color: #e53e3e;
    font-weight: 500;
  }
  
  .action-buttons {
    text-align: right;
    margin-top: 20px;
  }
  
  .btn {
    padding: 12px 24px;
    background-color: #4299e1;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
  }
  
  .btn-primary {
    background-color: #4299e1;
  }
  
  .empty-message {
    text-align: center;
    padding: 20px;
    color: #718096;
  }
</style>
{% endblock %}