{% extends "base.html" %}

{% block title %}Supplier List{% endblock %}

{% block content %}
  <title>Milk Lot Entries</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f9fc;
      margin-left: 40px;
      padding: 0px;
      color: #333;
    }
    
    .container {
      width: 1180px;              
      height: 100%;           
      margin: 0;                 
      border-radius: 0;         
      max-width: none;         
      box-shadow: none;          
      padding: 30px;
      box-sizing: border-box;   
      overflow: auto;           
    }
    
    h2 {
      color: #2c5282;
      margin-bottom: 25px;
      font-weight: 600;
      border-bottom: 2px solid #ebf2f7;
      padding-bottom: 10px;
    }
    
    .milk-lot-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    .milk-lot-table thead {
      background-color: #ebf8ff;
      color: #2b6cb0;
    }
    
    .milk-lot-table th {
      padding: 10px;
      text-align: left;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.75em;
      letter-spacing: 0.5px;
    }
    
    .milk-lot-table td {
      font-size: small;
      padding: 7px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .milk-lot-table tr:nth-child(even) {
      background-color: #f8fafc;
    }
    
    .milk-lot-table tr:hover {
      background-color: #ebf8ff;
    }
    
    .status-pending {
      color: #d69e2e;
      font-weight: 500;
    }
    
    .status-approved {
      color: #38a169;
      font-weight: 500;
    }
    
    .status-rejected {
      color: #e53e3e;
      font-weight: 500;
    }
    
    .price-cell {
      font-weight: 600;
      color: #2b6cb0;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    
    .btn {
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 0.85em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      text-decoration: none;
    }
    
    .btn-view {
      background-color: #4299e1;
      color: white;
    }
    
    .btn-view:hover {
      background-color: #3182ce;
    }
    
    .btn-edit {
      background-color: #68d391;
      color: white;
    }
    
    .btn-edit:hover {
      background-color: #48bb78;
    }
    
    .btn-delete {
      background-color: #fc8181;
      color: white;
    }
    
    .btn-delete:hover {
      background-color: #f56565;
    }
    
    .empty-state {
      text-align: center;
      padding: 30px;
      color: #718096;
      background-color: #f8fafc;
      border-radius: 4px;
    }
    
  .floating-btn {
    position: fixed;
    right: 50px;
    z-index: 999;
    padding: 12px 20px;
    font-size: 16px;
    border-radius: 8px;
    background-color: #007bff;
    color: white;
    font-weight: bold;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2);
    transition: background-color 0.3s, transform 0.2s;
    text-decoration: none;     
    display: inline-block;     
  }

  
  #create-milk-lot-btn {
    bottom: 540px;      
    right:10px       
  }


  .floating-btn:hover {
    background-color: #0056b3;
    transform: translateY(-2px);
  }


  .floating-btn:active {
    transform: translateY(0);
  }


/* Modal Styles */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.4);
  overflow: auto; /* Enable scrolling if needed */
}

.modal-content {
  background-color: #fff;
  margin: 2% auto; /* Reduced from 15% to give more space */
  padding: 25px;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  width: 80%;
  max-width: 900px;
  max-height: 85vh; /* Limit height and enable scrolling */
  overflow-y: auto; /* Enable vertical scrolling */
  border: 1px solid #e2e8f0;
  position: relative;
}

.modal h2 {
  color: #2c5282;
  margin-bottom: 20px;
  font-weight: 600;
  border-bottom: 2px solid #ebf2f7;
  padding-bottom: 10px;
}

.close {
  position: absolute;
  right: 25px;
  top: 15px;
  color: #aaa;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  transition: color 0.3s;
}

.close:hover {
  color: #2c5282;
}

/*------------------------------------------------ Modal Table Styles ----------------------------------------------------------------------------*/
.modal-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
  font-size: 14px;
}

.modal-table th, 
.modal-table td {
  padding: 12px 15px;
  text-align: left;
  border-bottom: 1px solid #e2e8f0;
}

.modal-table th {
  background-color: #ebf8ff;
  color: #2b6cb0;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.85em;
  letter-spacing: 0.5px;
}

.modal-table tr:nth-child(even) {
  background-color: #f8fafc;
}

.modal-table tr:hover {
  background-color: #ebf8ff;
}

@media (max-width: 768px) {
  .modal-content {
    width: 95%;
    margin: 10px auto;
    padding: 15px;
  }
  
  .modal-table th, 
  .modal-table td {
    padding: 8px 10px;
    font-size: 13px;
  }
}

.modal-content::-webkit-scrollbar {
  width: 8px;
}

.modal-content::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.modal-content::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 4px;
}

.modal-content::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}
</style>

</head>
<body>
  <div class="container">
   
    <h2>Milk Lot Entries</h2>
    
    <a href="{% url 'create_milk_lot' %}" id="create-milk-lot-btn" class="floating-btn">
      + Create New Milk Lot
    </a>

    
    <table class="milk-lot-table">
      <thead>
        <tr>
          <th>Date tested</th>
          <th>Milk Lot ID</th>
          <th>Volume (L)</th>
          <th>Fat %</th>
          <th>Bacterial Count (CFU)</th>
          <th>Protein %</th>
          <th>Status</th>
          <th>Total Price</th>
          <th>Supplier ID name</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
  <!-------------------------------------------------- Modal for view MilkLot ---------------------------------------------------------------->
  <div id="milkLotModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Milk Lot Details</h2>
      <table class="modal-table">
        <tr><th>Field</th><th>Value</th><th>Standard</th><th>Anomaly (%)</th></tr>
        <tr><td>ID</td><td id="modal-id"></td><td>-</td><td>-</td></tr>
        <tr><td>Date tested</td><td id="modal-dateCreated"></td><td>-</td><td>-</td></tr>
        <tr><td>Volume (L)</td><td id="modal-volumeL"></td><td>-</td><td>-</td></tr>
        <tr><td>Fat (%)</td><td id="modal-fatPercent"></td><td id="modal-fatStandard"></td><td id="modal-fatAnomaly"></td></tr>
        <tr><td>Protein (%)</td><td id="modal-proteinPercent"></td><td id="modal-proteinStandard"></td><td id="modal-proteinAnomaly"></td></tr>
        <tr><td>Lactose (%)</td><td id="modal-lactosePercent"></td><td id="modal-lactoseStandard"></td><td id="modal-lactoseAnomaly"></td></tr>
        <tr><td>Total Solids</td><td id="modal-totalSolids"></td><td id="modal-totalSolidsStandard"></td><td id="modal-totalSolidsAnomaly"></td></tr>
        <tr><td>SNF</td><td id="modal-snf"></td><td id="modal-snfStandard"></td><td id="modal-snfAnomaly"></td></tr>
        <tr><td>Urea Nitrogen</td><td id="modal-ureaNitrogen"></td><td id="modal-ureaNitrogenStandard"></td><td id="modal-ureaNitrogenAnomaly"></td></tr>
        <tr><td>Bacterial Count</td><td id="modal-bacterialCount"></td><td id="modal-bacterialCountStandard"></td><td id="modal-bacterialCountAnomaly"></td></tr>
        <tr><td>Total Price</td><td id="modal-totalPrice">₹<span></span></td><td>-</td><td>-</td></tr>
        <tr><td>Price Per Litre</td><td id="modal-pricePerLitre">₹<span></span></td><td>-</td><td>-</td></tr>
        <tr><td>Status</td><td id="modal-status"></td><td>-</td><td>-</td></tr>
        <tr><td>Added Water (%)</td><td id="modal-addedWaterPercent"></td><td id="modal-addedWaterStandard"></td><td id="modal-addedWaterAnomaly"></td></tr>
        <tr><td>Supplier</td><td id="modal-supplier"></td><td>-</td><td>-</td></tr>
      </table>
    </div>
  </div>
<script>
//===================================function to gather all Milk Lots and associated information ====================================================//
document.addEventListener("DOMContentLoaded", async () => {
  const tableBody = document.querySelector(".milk-lot-table tbody");

  const query = `
    query {
      milkLotList {
        id
        volumeL
        fatPercent
        proteinPercent
        bacterialCount
        status
        totalPrice
        dateCreated
        supplier {
          id
          email
        }
      }
    }
  `;

  try {
    const res = await fetch("/graphql/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ query })
    });

    const json = await res.json();

    if (json.errors) {
      console.error("GraphQL errors:", json.errors);
      tableBody.innerHTML = `<tr><td colspan="10">Error loading data</td></tr>`;
      return;
    }

    const milkLots = json.data.milkLotList;

    if (milkLots.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="10" class="empty-state">No milk lot entries found.</td></tr>`;
      return;
    }

    milkLots.forEach(lot => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${lot.dateCreated}</td>
        <td>${lot.id}</td>
        <td>${lot.volumeL}</td>
        <td>${lot.fatPercent}%</td>
        <td>${lot.bacterialCount}</td>
        <td>${lot.proteinPercent}%</td>
        <td class="status-${lot.status.toLowerCase()}">${lot.status}</td>
        <td class="price-cell">₹${lot.totalPrice}</td>
        <td>${lot.supplier.id} - ${lot.supplier.email}</td>
        <td>
        <div class="action-buttons">
          <a href="#" class="btn btn-view" data-id="${lot.id}">
            <i class="fas fa-eye"></i>
          </a>
          <a href="#" class="btn btn-edit" data-id="${lot.id}">
              <i class="fas fa-edit"></i>
          </a>
          <a href="" class="btn btn-delete">
            <i class="fas fa-trash"></i>
          </a>
        </div>
      </td>

      `;
      tableBody.appendChild(row);
    });
  } catch (err) {
    console.error("Error fetching milk lots:", err);
    tableBody.innerHTML = `<tr><td colspan="10">Error loading data</td></tr>`;
  }
});

//============================================= modal view function to dispaly Milk Lot Information =================================================//
document.addEventListener("click", async function (e) {
  const viewBtn = e.target.closest(".btn-view");
  if (!viewBtn) return;

  e.preventDefault();

  const standards = { fatPercent: 3.5, proteinPercent: 3.0, lactosePercent: 4.6, totalSolids: 12.5, snf: 8.5, ureaNitrogen: {min:15,max:40}, bacterialCount:50000, addedWaterPercent:3 };

  const lotId = parseInt(viewBtn.dataset.id);

  const fetchMilkLotQuery = `
    query GetMilkLotById($id: Int!) {
      milkLotById(id: $id) {
        id
        supplier { id email user { username } }
        tester { id user { username } }
        status
        volumeL fatPercent proteinPercent lactosePercent totalSolids snf pricePerLitre totalPrice ureaNitrogen bacterialCount addedWaterPercent dateCreated
      }
    }
  `;

  try {
    const res = await fetch("/graphql/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ query: fetchMilkLotQuery, variables: { id: lotId } })
    });
    const result = await res.json();
    if (result.errors) { alert(result.errors[0].message); return; }

    const lot = result.data.milkLotById;

    
    document.getElementById("modal-id").textContent = lot.id;
    document.getElementById("modal-dateCreated").textContent = lot.dateCreated;
    document.getElementById("modal-volumeL").textContent = lot.volumeL + " L";

    // Fat
    const fat = lot.fatPercent;
    const fatStd = standards.fatPercent;
    let fatAnomaly = fat < fatStd ? `Low (below ${fatStd}%) – potential dilution` : `Normal`;
    document.getElementById("modal-fatPercent").textContent = fat + "%";
    document.getElementById("modal-fatStandard").textContent = fatStd + "%";
    document.getElementById("modal-fatAnomaly").textContent = fatAnomaly;

    // Protein
    const protein = lot.proteinPercent;
    const proteinStd = standards.proteinPercent;
    let proteinAnomaly = protein < proteinStd ? `Low (below ${proteinStd}%) – poor quality or adulteration` : `Normal`;
    document.getElementById("modal-proteinPercent").textContent = protein + "%";
    document.getElementById("modal-proteinStandard").textContent = proteinStd + "%";
    document.getElementById("modal-proteinAnomaly").textContent = proteinAnomaly;

    // Lactose
    const lactose = lot.lactosePercent;
    const lactoseStd = standards.lactosePercent;
    let lactoseAnomaly = Math.abs(lactose - lactoseStd) > 0.5 ? `Deviation detected – possible adulteration` : `Normal`;
    document.getElementById("modal-lactosePercent").textContent = lactose + "%";
    document.getElementById("modal-lactoseStandard").textContent = lactoseStd + "%";
    document.getElementById("modal-lactoseAnomaly").textContent = lactoseAnomaly;

    // status
    const testStatus = lot.status;
    document.getElementById("modal-status").textContent = testStatus;

    // Total Solids
    const ts = lot.totalSolids;
    const tsStd = standards.totalSolids;
    let tsAnomaly = ts < tsStd ? `Low – potential water addition` : `Normal`;
    document.getElementById("modal-totalSolids").textContent = ts;
    document.getElementById("modal-totalSolidsStandard").textContent = tsStd + "%";
    document.getElementById("modal-totalSolidsAnomaly").textContent = tsAnomaly;

    // SNF
    const snf = lot.snf;
    const snfStd = standards.snf;
    let snfAnomaly = snf < snfStd ? `Below standard – quality concern` : `Normal`;
    document.getElementById("modal-snf").textContent = snf;
    document.getElementById("modal-snfStandard").textContent = snfStd + "%";
    document.getElementById("modal-snfAnomaly").textContent = snfAnomaly;

    // Urea Nitrogen
    const urea = lot.ureaNitrogen;
    let ureaAnomaly = "Normal";
    if (urea < standards.ureaNitrogen.min) ureaAnomaly = `Below min – possible adulteration`;
    else if (urea > standards.ureaNitrogen.max) ureaAnomaly = `Above max – excessive urea addition`;
    document.getElementById("modal-ureaNitrogen").textContent = urea;
    document.getElementById("modal-ureaNitrogenStandard").textContent = `${standards.ureaNitrogen.min} – ${standards.ureaNitrogen.max} mg/dL`;
    document.getElementById("modal-ureaNitrogenAnomaly").textContent = ureaAnomaly;

    // Bacterial Count
    const bac = lot.bacterialCount;
    const bacStd = standards.bacterialCount;
    let bacAnomaly = bac > bacStd ? `High – microbiological risk` : `Normal`;
    document.getElementById("modal-bacterialCount").textContent = bac;
    document.getElementById("modal-bacterialCountStandard").textContent = bacStd.toLocaleString();
    document.getElementById("modal-bacterialCountAnomaly").textContent = bacAnomaly;

    // Added Water
    const water = lot.addedWaterPercent;
    const waterStd = standards.addedWaterPercent;
    let waterAnomaly = water > waterStd ? `Excess water detected` : `Normal`;
    document.getElementById("modal-addedWaterPercent").textContent = water + "%";
    document.getElementById("modal-addedWaterStandard").textContent = waterStd + "%";
    document.getElementById("modal-addedWaterAnomaly").textContent = waterAnomaly;

    const totalPrice = lot.totalPrice;
    document.getElementById("modal-totalPrice").textContent = totalPrice;

    const pricePerLitre = lot.pricePerLitre;
    document.getElementById("modal-pricePerLitre").textContent = pricePerLitre;

    // Supplier
    document.getElementById("modal-supplier").textContent = `${lot.supplier.id} - ${lot.supplier.email}`;

    // Show modal
    document.getElementById("milkLotModal").style.display = "block";
    document.querySelector("#milkLotModal .close").addEventListener("click", () => { document.getElementById("milkLotModal").style.display = "none"; });

  } catch(error){
    console.error("Network error:", error);
    alert("Failed to load milk lot details.");
  }
});

window.addEventListener("click", function(e){
  const modal = document.getElementById("milkLotModal");
  if(e.target === modal) modal.style.display = "none";
});


//=========================================== get and move to Milk Lot by ID url =======================================================//
document.addEventListener("click", function (e) {
    const editBtn = e.target.closest(".btn-edit");
    if (!editBtn) return;
    e.preventDefault(); 
    const lotId = editBtn.dataset.id;
    window.location.href = `/milk-lot/edit/${lotId}/`;
});
</script>
{% endblock %}