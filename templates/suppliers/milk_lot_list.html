{% extends "base.html" %}

{% block title %}Supplier List{% endblock %}

{% block content %}
  <title>Milk Lot Entries</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f9fc;
      margin-left: 40px;
      padding: 0px;
      color: #333;
      font-size: 14px; 
    }
    
    .container {
      width: 1180px;              
      height: 100%;           
      margin: 0;                 
      border-radius: 0;         
      max-width: none;         
      box-shadow: none;          
      padding: 30px;
      box-sizing: border-box;   
      overflow: auto;           
    }
    
    h2 {
      color: #2c5282;
      margin-bottom: 10px;
      font-weight: 600;
      border-bottom: 2px solid #ebf2f7;
      padding-bottom: 10px;
    }
    
    .milk-lot-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    
    .milk-lot-table thead {
      background-color: #ebf8ff;
      color: #2b6cb0;
    }
    
    .milk-lot-table th {
      padding: 10px;
      text-align: left;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.75em;
      letter-spacing: 0.5px;
    }
    
    .milk-lot-table td {
      font-size: small;
      padding: 7px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .milk-lot-table tr:nth-child(even) {
      background-color: #f8fafc;
    }
    
    .milk-lot-table tr:hover {
      background-color: #ebf8ff;
    }
    
    .status-pending {
      color: #d69e2e;
      font-weight: 500;
    }
    
    .status-approved {
      color: #38a169;
      font-weight: 500;
    }
    
    .status-rejected {
      color: #e53e3e;
      font-weight: 500;
    }
    
    .price-cell {
      font-weight: 600;
      color: #2b6cb0;
    }
    
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    
    .btn {
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 0.85em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
      text-decoration: none;
    }
    
    .btn-view {
      background-color: #4299e1;
      color: white;
    }
    
    .btn-view:hover {
      background-color: #3182ce;
    }
    
    .btn-edit {
      background-color: #68d391;
      color: white;
    }
    
    .btn-edit:hover {
      background-color: #48bb78;
    }
    
    .btn-delete {
      background-color: #fc8181;
      color: white;
    }
    
    .btn-delete:hover {
      background-color: #f56565;
    }
    
    .empty-state {
      text-align: center;
      padding: 30px;
      color: #718096;
      background-color: #f8fafc;
      border-radius: 4px;
    }
    .create-btn {
      display: inline-block;
      margin: 15px 0 25px;
      padding: 10px 20px;
      font-size: 16px;
      font-weight: bold;
      color: white;
      background-color: #007bff;
      border: none;
      border-radius: 8px;
      text-decoration: none;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      transition: background-color 0.3s, transform 0.2s;
    }

    .create-btn:hover {
      background-color: #0056b3;
      transform: translateY(-2px);
    }

    .create-btn:active {
      transform: translateY(0);
    }



/* Modal Styles */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.4);
  overflow: auto; /* Enable scrolling if needed */
}

.modal-content {
  background-color: #fff;
  margin: 2% auto; /* Reduced from 15% to give more space */
  padding: 25px;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  width: 80%;
  max-width: 900px;
  max-height: 85vh; /* Limit height and enable scrolling */
  overflow-y: auto; /* Enable vertical scrolling */
  border: 1px solid #e2e8f0;
  position: relative;
}

.modal h2 {
  color: #2c5282;
  margin-bottom: 20px;
  font-weight: 600;
  border-bottom: 2px solid #ebf2f7;
  padding-bottom: 10px;
}

.close {
  position: absolute;
  right: 25px;
  top: 15px;
  color: #aaa;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  transition: color 0.3s;
}

.close:hover {
  color: #2c5282;
}

/*------------------------------------------------ Modal Table Styles ----------------------------------------------------------------------------*/
.modal-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
  font-size: 14px;
}

.modal-table th, 
.modal-table td {
  padding: 12px 15px;
  text-align: left;
  border-bottom: 1px solid #e2e8f0;
}

.modal-table th {
  background-color: #ebf8ff;
  color: #2b6cb0;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.85em;
  letter-spacing: 0.5px;
}

.modal-table tr:nth-child(even) {
  background-color: #f8fafc;
}

.modal-table tr:hover {
  background-color: #ebf8ff;
}

@media (max-width: 768px) {
  .modal-content {
    width: 95%;
    margin: 10px auto;
    padding: 15px;
  }
  
  .modal-table th, 
  .modal-table td {
    padding: 8px 10px;
    font-size: 13px;
  }
}

.modal-content::-webkit-scrollbar {
  width: 8px;
}

.modal-content::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.modal-content::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 4px;
}

.modal-content::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

.pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 12px;
  margin-top: 20px;
  padding: 12px 0;
}

.pagination button {
  padding: 6px 12px;
  border: 2px solid #043365;
  background-color: #f8fafc;
  color: #2b6cb0;
  border-radius: 4px;
  cursor: pointer;
  font-weight: 500;
  transition: background 0.2s;
}

.pagination button:hover:not(:disabled) {
  background-color: #0678eb;
  color: #f8f8f8;
}

.pagination button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.pagination span {
  min-width: 120px;
  text-align: center;
  color: #4a5568;
}
</style>

</head>
<body>
  <div class="container">
   
    <h2>Milk Lot Entries</h2>
    
    <a href="{% url 'create_milk_lot' %}" class="create-btn">
    + Create New Milk Lot
    </a>

    
    <table class="milk-lot-table">
      <thead>
        <tr>
          <th>Date tested</th>
          <th>Milk Lot ID</th>
          <th>Volume (L)</th>
          <th>Fat %</th>
          <th>Bacterial Count (CFU)</th>
          <th>Protein %</th>
          <th>Status</th>
          <th>Total Price</th>
          <th>Supplier ID name</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
    <div class="pagination" style="margin-top: 20px; text-align: center; font-size: 14px;">
      <!--================= Pagination buttons will be injected here by JS ======================-->
    </div>
  </div>
  <!-------------------------------------------------- Modal for view MilkLot ---------------------------------------------------------------->
  <div id="milkLotModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Milk Lot Details</h2>
      <table class="modal-table">
        <tr><th>Field</th><th>Value</th><th>Standard</th><th>Anomaly (%)</th></tr>
        <tr><td>ID</td><td id="modal-id"></td><td>-</td><td>-</td></tr>
        <tr><td>Date tested</td><td id="modal-dateCreated"></td><td>-</td><td>-</td></tr>
        <tr><td>Volume (L)</td><td id="modal-volumeL"></td><td>-</td><td>-</td></tr>
        <tr><td>Fat (%)</td><td id="modal-fatPercent"></td><td id="modal-fatStandard"></td><td id="modal-fatAnomaly"></td></tr>
        <tr><td>Protein (%)</td><td id="modal-proteinPercent"></td><td id="modal-proteinStandard"></td><td id="modal-proteinAnomaly"></td></tr>
        <tr><td>Lactose (%)</td><td id="modal-lactosePercent"></td><td id="modal-lactoseStandard"></td><td id="modal-lactoseAnomaly"></td></tr>
        <tr><td>Total Solids</td><td id="modal-totalSolids"></td><td id="modal-totalSolidsStandard"></td><td id="modal-totalSolidsAnomaly"></td></tr>
        <tr><td>SNF</td><td id="modal-snf"></td><td id="modal-snfStandard"></td><td id="modal-snfAnomaly"></td></tr>
        <tr><td>Urea Nitrogen</td><td id="modal-ureaNitrogen"></td><td id="modal-ureaNitrogenStandard"></td><td id="modal-ureaNitrogenAnomaly"></td></tr>
        <tr><td>Bacterial Count</td><td id="modal-bacterialCount"></td><td id="modal-bacterialCountStandard"></td><td id="modal-bacterialCountAnomaly"></td></tr>
        <tr><td>Total Price</td><td id="modal-totalPrice">₹<span></span></td><td>-</td><td>-</td></tr>
        <tr><td>Price Per Litre</td><td id="modal-pricePerLitre">₹<span></span></td><td>-</td><td>-</td></tr>
        <tr><td>Status</td><td id="modal-status"></td><td>-</td><td>-</td></tr>
        <tr><td>Added Water (%)</td><td id="modal-addedWaterPercent"></td><td id="modal-addedWaterStandard"></td><td id="modal-addedWaterAnomaly"></td></tr>
        <tr><td>Supplier</td><td id="modal-supplier"></td><td>-</td><td>-</td></tr>
      </table>
    </div>
  </div>
<script>
document.addEventListener("DOMContentLoaded", async () => {

    // =============================Initialize Access Token (refresh → access)=======================================
    const ok = await initializeAccessToken();
    if (!ok) {
        console.warn("No refresh token — redirecting to login");
        window.location.href = "/";
        return;
    }

    const tableBody = document.querySelector(".milk-lot-table tbody");
    function renderPaginationControls(data) {
        const paginationDiv = document.querySelector(".pagination");

        paginationDiv.innerHTML = `
            <button ${data.currentPage === 1 ? "disabled" : ""}
                onclick="loadMilkLots(${data.currentPage - 1})">Prev</button>

            <span> Page ${data.currentPage} of ${data.totalPages} </span>

            <button ${data.currentPage === data.totalPages ? "disabled" : ""}
                onclick="loadMilkLots(${data.currentPage + 1})">Next</button>
        `;
    }

    function renderMilkLotTable(items) {
        tableBody.innerHTML = ""; 

        if (!items.length) {
            tableBody.innerHTML = `<tr><td colspan="10">No milk lots found</td></tr>`;
            return;
        }

        items.forEach(lot => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${lot.dateCreated}</td>
                <td>${lot.id}</td>
                <td>${lot.volumeL}</td>
                <td>${lot.fatPercent}%</td>
                <td>${lot.bacterialCount}</td>
                <td>${lot.proteinPercent}%</td>
                <td class="status-${lot.status.toLowerCase()}">${lot.status}</td>
                <td class="price-cell">₹${lot.totalPrice}</td>
                <td>${lot.supplier.id} - ${lot.supplier.email}</td>
                <td>
                    <div class="action-buttons">
                        <a href="#" class="btn btn-view" data-id="${lot.id}">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a href="#" class="btn btn-edit" data-id="${lot.id}">
                            <i class="fas fa-edit"></i>
                        </a>
                        <a href="#" class="btn btn-delete">
                            <i class="fas fa-trash"></i>
                        </a>
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

  
    window.loadMilkLots = async function(page = 1, perPage = 30) {
        const query = `
            query GetMilkLots($page: Int!, $perPage: Int!) {
                milkLotList(pagination: { page: $page, perPage: $perPage }) {
                    items {
                        id
                        volumeL
                        fatPercent
                        proteinPercent
                        bacterialCount
                        status
                        totalPrice
                        dateCreated
                        supplier { id email }
                    }
                    totalItems
                    totalPages
                    currentPage
                    perPage
                }
            }
        `;

        const variables = { page, perPage };
        const result = await securedGraphQL(query, variables);

        if (result.errors) {
            console.error("GraphQL Error:", result.errors);
            return;
        }

        const data = result.data.milkLotList;
        renderMilkLotTable(data.items);
        renderPaginationControls(data);
    };


    loadMilkLots();

}); 

function getAnomalyStyle(anomalyText) {
    if (anomalyText.includes("Normal")) {
        return { bg: "#d4edda", color: "#155724" }; // green
    } else if (
        anomalyText.includes("Low") ||
        anomalyText.includes("High") ||
        anomalyText.includes("Excess") ||
        anomalyText.includes("Below") ||
        anomalyText.includes("Above") ||
        anomalyText.includes("Deviation") ||
        anomalyText.includes("risk") ||
        anomalyText.includes("concern") ||
        anomalyText.includes("adulteration")
    ) {
        return { bg: "#f8d7da", color: "#721c24" }; // red
    } else {
        return { bg: "#fff3cd", color: "#856404" }; // yellow (fallback)
    }
}

function applyAnomalyStyle(cellId, anomalyText) {
    const cell = document.getElementById(cellId);
    if (!cell) return;

    cell.textContent = anomalyText;
    const style = getAnomalyStyle(anomalyText);
    cell.style.backgroundColor = style.bg;
    cell.style.color = style.color;
    cell.style.padding = "8px";
    cell.style.borderRadius = "4px";
    cell.style.fontWeight = "500";
}


document.addEventListener("click", async function (e) {

    // ----------------------- VIEW BUTTON -----------------------
    const viewBtn = e.target.closest(".btn-view");
    if (viewBtn) {
        e.preventDefault();
        const lotId = parseInt(viewBtn.dataset.id);

        const standards = {
            fatPercent: 3.5,
            proteinPercent: 3.0,
            lactosePercent: 4.6,
            totalSolids: 12.5,
            snf: 8.5,
            ureaNitrogen: { min: 15, max: 40 },
            bacterialCount: 50000,
            addedWaterPercent: 3
        };

        const fetchMilkLotQuery = `
            query GetMilkLotById($id: Int!) {
                milkLotById(id: $id) {
                    id
                    supplier { id email }
                    status
                    volumeL
                    fatPercent
                    proteinPercent
                    lactosePercent
                    totalSolids
                    snf
                    pricePerLitre
                    totalPrice
                    ureaNitrogen
                    bacterialCount
                    addedWaterPercent
                    dateCreated
                }
            }
        `;

        try {
            const result = await securedGraphQL(fetchMilkLotQuery, { id: lotId });
            if (result.errors) {
                alert(result.errors[0].message);
                return;
            }

            const lot = result.data.milkLotById;

            const anomalyCells = document.querySelectorAll('[id$="Anomaly"]');
            anomalyCells.forEach(cell => {
                cell.style.backgroundColor = "";
                cell.style.color = "";
                cell.style.padding = "";
                cell.style.borderRadius = "";
                cell.style.fontWeight = "";
            });

            // Populate basic fields
            document.getElementById("modal-id").textContent = lot.id;
            document.getElementById("modal-dateCreated").textContent = lot.dateCreated;
            document.getElementById("modal-volumeL").textContent = `${lot.volumeL} L`;

            const statusCell = document.getElementById("modal-status");
            statusCell.textContent = lot.status;
            statusCell.className = `status-${lot.status.toLowerCase()}`;

            // === Fat ===
            const fat = lot.fatPercent;
            const fatStd = standards.fatPercent;
            const fatAnomaly = fat < fatStd ? `Low (below ${fatStd}%) – potential dilution` : `Normal`;
            document.getElementById("modal-fatPercent").textContent = `${fat}%`;
            document.getElementById("modal-fatStandard").textContent = `${fatStd}%`;
            applyAnomalyStyle("modal-fatAnomaly", fatAnomaly);

            // === Protein ===
            const protein = lot.proteinPercent;
            const proteinStd = standards.proteinPercent;
            const proteinAnomaly = protein < proteinStd ? `Low (below ${proteinStd}%) – poor quality or adulteration` : `Normal`;
            document.getElementById("modal-proteinPercent").textContent = `${protein}%`;
            document.getElementById("modal-proteinStandard").textContent = `${proteinStd}%`;
            applyAnomalyStyle("modal-proteinAnomaly", proteinAnomaly);

            // === Lactose ===
            const lactose = lot.lactosePercent;
            const lactoseStd = standards.lactosePercent;
            const lactoseAnomaly = Math.abs(lactose - lactoseStd) > 0.5 ? `Deviation detected – possible adulteration` : `Normal`;
            document.getElementById("modal-lactosePercent").textContent = `${lactose}%`;
            document.getElementById("modal-lactoseStandard").textContent = `${lactoseStd}%`;
            applyAnomalyStyle("modal-lactoseAnomaly", lactoseAnomaly);

            // === Total Solids ===
            const ts = lot.totalSolids;
            const tsStd = standards.totalSolids;
            const tsAnomaly = ts < tsStd ? `Low – potential water addition` : `Normal`;
            document.getElementById("modal-totalSolids").textContent = ts;
            document.getElementById("modal-totalSolidsStandard").textContent = `${tsStd}%`;
            applyAnomalyStyle("modal-totalSolidsAnomaly", tsAnomaly);

            // === SNF ===
            const snf = lot.snf;
            const snfStd = standards.snf;
            const snfAnomaly = snf < snfStd ? `Below standard – quality concern` : `Normal`;
            document.getElementById("modal-snf").textContent = snf;
            document.getElementById("modal-snfStandard").textContent = `${snfStd}%`;
            applyAnomalyStyle("modal-snfAnomaly", snfAnomaly);

            // === Urea Nitrogen ===
            const urea = lot.ureaNitrogen;
            let ureaAnomaly = "Normal";
            if (urea < standards.ureaNitrogen.min) {
                ureaAnomaly = `Below min – possible adulteration`;
            } else if (urea > standards.ureaNitrogen.max) {
                ureaAnomaly = `Above max – excessive urea addition`;
            }
            document.getElementById("modal-ureaNitrogen").textContent = urea;
            document.getElementById("modal-ureaNitrogenStandard").textContent = `${standards.ureaNitrogen.min} – ${standards.ureaNitrogen.max} mg/dL`;
            applyAnomalyStyle("modal-ureaNitrogenAnomaly", ureaAnomaly);

            // === Bacterial Count ===
            const bac = lot.bacterialCount;
            const bacStd = standards.bacterialCount;
            const bacAnomaly = bac > bacStd ? `High – microbiological risk` : `Normal`;
            document.getElementById("modal-bacterialCount").textContent = bac;
            document.getElementById("modal-bacterialCountStandard").textContent = bacStd.toLocaleString();
            applyAnomalyStyle("modal-bacterialCountAnomaly", bacAnomaly);

            // === Added Water ===
            const water = lot.addedWaterPercent;
            const waterStd = standards.addedWaterPercent;
            const waterAnomaly = water > waterStd ? `Excess water detected` : `Normal`;
            document.getElementById("modal-addedWaterPercent").textContent = `${water}%`;
            document.getElementById("modal-addedWaterStandard").textContent = `${waterStd}%`;
            applyAnomalyStyle("modal-addedWaterAnomaly", waterAnomaly);

            // Pricing & Supplier
            document.getElementById("modal-totalPrice").textContent = `₹${lot.totalPrice}`;
            document.getElementById("modal-pricePerLitre").textContent = `₹${lot.pricePerLitre}`;
            document.getElementById("modal-supplier").textContent = `${lot.supplier.id} - ${lot.supplier.email}`;

            // Show modal
            document.getElementById("milkLotModal").style.display = "block";

            // Attach close handler (in case reused)
            const closeBtn = document.querySelector("#milkLotModal .close");
            if (closeBtn) {
                closeBtn.onclick = () => {
                    document.getElementById("milkLotModal").style.display = "none";
                };
            }

        } catch (error) {
            console.error("Network error:", error);
            alert("Failed to load milk lot details.");
        }

        return;
    }

    // ----------------------- EDIT BUTTON -----------------------
    const editBtn = e.target.closest(".btn-edit");
    if (editBtn) {
        e.preventDefault();
        const id = editBtn.dataset.id;
        window.location.href = `/milk-lot/edit/${id}/`;
    }
});


window.addEventListener("click", function (e) {
    const modal = document.getElementById("milkLotModal");
    if (e.target === modal) {
        modal.style.display = "none";
    }
});
</script>
{% endblock %}