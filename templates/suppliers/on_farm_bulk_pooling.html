{% extends "base.html" %}

{% block title %}On-Farm Tank Management{% endblock %}

{% block content %}
<div class="container">
  <h1>On-Farm Tank Management</h1>
  
  <!-- Tank Selection Card -->
  <div class="tank-selection-card">
    <div class="section-title">Tank Details</div>
    
    <div class="tank-form-grid">
      <!-- Supplier and Tank Selection -->
      <div class="form-group">
        <label for="supplier">Supplier</label>
        <select id="supplier" name="supplier" required>
          <option value="">Select Supplier</option>      
        </select>
      </div>
      
      <div class="form-group">
        <label for="tank">Farm Tank</label>
        <select id="tank" name="tank" required>
          <option value="">Select Farm Tank</option>
        </select>
      </div>
      
      <!-- Capacity Display -->
      <div class="capacity-display">
        <div class="capacity-item">
          <span>Total Capacity:</span>
          <strong id="total-capacity">0</strong> L
        </div>
        <div class="capacity-item">
          <span>Current Volume:</span>
          <strong id="current-volume">0</strong> L
        </div>
        <div class="capacity-item">
          <span>Available Space:</span>
          <strong id="available-space">0</strong> L
        </div>
      </div>
      
      <!-- Tank Status Fields -->
      <div class="form-group">
        <label for="temperature">Temperature (Â°C)</label>
        <input type="number" id="temperature" name="temperature_celsius" 
               step="0.1" min="0" max="8">
      </div>
      
      <!-- Maintenance Fields -->
      <div class="form-group">
        <label for="last_cleaned">Last Cleaned At</label>
        <input type="datetime-local" id="last_cleaned" name="last_cleaned_at">
      </div>
      
      <div class="form-group">
        <label for="last_sanitized">Last Sanitized At</label>
        <input type="datetime-local" id="last_sanitized" name="last_sanitized_at">
      </div>
      
      <div class="form-group">
        <label for="last_calibrated">Last Calibrated At</label>
        <input type="datetime-local" id="last_calibrated" name="last_calibration_date">
      </div>
      
      <div class="form-group">
        <label for="service_interval">Service Interval (days)</label>
        <input type="number" id="service_interval" name="service_interval_days" 
               min="1" value="90">
      </div>
      
      <div class="form-group">
        <label for="last_serviced">Last Serviced At</label>
        <input type="datetime-local" id="last_serviced" name="last_serviced_at">
      </div>
      
    </div>
  </div>
  
  <!-- Milk Lots Assignment Section -->
  <div class="milk-lots-section">
    <div class="section-header">
      <h2>Approved Milk Lots</h2>
      <div class="selection-info">
        <span>Selected Volume: </span>
        <strong id="selected-volume">0</strong> L
      </div>
    </div>
    
    <div class="select-all-container">
      <input type="checkbox" id="select-all">
      <label for="select-all">Select all unassigned lots</label>
    </div>
    
    <table class="milk-lots-table">
      <thead>
        <tr>
          <th>MilkLot ID</th>
          <th>Date tested</th>
          <th>Supplier</th>
          <th>Volume (L)</th>
          <th>Fat %</th>
          <th>Protein %</th>
          <th>Added water %</th>
          <th>Status</th>
          <th>Assigned To</th>
          <th>Select</th>
        </tr>
      </thead>
      <tbody>
     
      </tbody>
    </table>
    
    <div class="action-buttons">
      <button type="button" class="btn btn-primary" id="assign-btn">
        Assign Selected to Tank
      </button>
    </div>
  </div>
</div>

<style>
  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #333;
  }
  
  h1 {
    color: #2c5282;
    font-weight: 600;
    margin-bottom: 25px;
    border-bottom: 2px solid #ebf2f7;
    padding-bottom: 10px;
  }
  
  .tank-selection-card {
    background-color: #ebf8ff;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  
  .section-title {
    color: #2b6cb0;
    font-weight: 600;
    margin-bottom: 20px;
    font-size: 1.2em;
  }
  
  .tank-form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
  }
  
  .form-group {
    margin-bottom: 15px;
  }
  
  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #4a5568;
  }
  
  select, input {
    width: 100%;
    padding: 10px;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    font-size: 16px;
    background-color: white;
  }
  
  .capacity-display {
    display: flex;
    gap: 20px;
    padding: 15px;
    background-color: #f0fff4;
    border-radius: 8px;
    margin: 15px 0;
    grid-column: 1 / -1;
    border: 1px solid #c6f6d5;
  }
  
  .capacity-item {
    flex: 1;
    text-align: center;
  }
  
  .capacity-item strong {
    color: #2b6cb0;
    font-weight: 600;
  }
  
  .milk-lots-section {
    background-color: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  
  .selection-info {
    font-size: 1.1em;
    color: #4a5568;
  }
  
  .selection-info strong {
    color: #2b6cb0;
  }
  
  .select-all-container {
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .milk-lots-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  
  .milk-lots-table th {
    background-color: #ebf8ff;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: #2b6cb0;
    text-transform: uppercase;
    font-size: 0.85em;
  }
  
  .milk-lots-table td {
    padding: 12px;
    border-bottom: 1px solid #e2e8f0;
  }
  
  .milk-lots-table tr:nth-child(even) {
    background-color: #f8fafc;
  }
  
  .milk-lots-table tr:hover {
    background-color: #ebf8ff;
  }
  
  .status-approved {
    color: #38a169;
    font-weight: 500;
  }
  
  .status-pending {
    color: #d69e2e;
    font-weight: 500;
  }
  
  .unassigned {
    color: #e53e3e;
    font-weight: 500;
  }
  
  .action-buttons {
    text-align: right;
    margin-top: 20px;
  }
  
  .btn {
    padding: 12px 24px;
    background-color: #4299e1;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  
  .btn:hover {
    background-color: #3182ce;
  }
  
  .empty-message {
    text-align: center;
    padding: 20px;
    color: #718096;
    background-color: #f8fafc;
    border-radius: 4px;
  }
  
</style>

<script>
  //---------------------------------------load supplier name and Id------------------------------------------//
  async function loadSuppliers() {
    const query = `
      query {
        suppliers {
          id
          user{
            username
          }
        }
      }
    `;

    try {
      const response = await fetch("/graphql/", {   
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"), 
        },
        body: JSON.stringify({ query })
      });

      const result = await response.json();
      const suppliers = result.data.suppliers;

      const supplierSelect = document.getElementById("supplier");

      suppliers.forEach(supplier => {
        const option = document.createElement("option");
        option.value = supplier.id;
        option.textContent = `${supplier.id} - ${supplier.user.username}`;
        supplierSelect.appendChild(option);
      });

    } catch (error) {
      console.error("Error loading suppliers:", error);
    }
  }

  document.addEventListener("DOMContentLoaded", loadSuppliers);

//--------------------------------------------load OnFarm Tanks for selected Suppliers -------------------------------------------------//
async function loadTanksForSupplier(supplierId) {
  const query = `
    query ($supplierId: Int!) {
      onFarmTanksBySupplier(supplierId: $supplierId) {
        id
        name
        capacityLiters
        currentVolumeLiters
        supplier {
          id
          user{
            username
          }
        }
        temperatureCelsius
        lastCleanedAt
        lastSanitizedAt
        lastCalibrationDate
        serviceIntervalDays
        lastServicedAt 
      }
    }
  `;

  const variables = { supplierId };

  try {
    const res = await fetch("/graphql/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ query, variables })
    });

    const result = await res.json();
    const tanks = result.data.onFarmTanksBySupplier;

    const tankSelect = document.getElementById("tank");
    tankSelect.innerHTML = `
      <option value="">Select Farm Tank</option>
    `; 

    tanks.forEach(tank => {
      const option = document.createElement("option");
      option.value = tank.id;
      option.textContent = `${tank.supplier.user.username}'s ${tank.name} (${tank.capacityLiters} L)`;
      option.dataset.capacity = tank.capacityLiters;
      option.dataset.current = tank.currentVolumeLiters;
      option.dataset.capacity = tank.capacityLiters;
      option.dataset.current = tank.currentVolumeLiters;
      option.dataset.temperature = tank.temperatureCelsius || "";
      option.dataset.lastCleaned = tank.lastCleanedAt || "";
      option.dataset.lastSanitized = tank.lastSanitizedAt || "";
      option.dataset.lastCalibrated = tank.lastCalibrationDate || "";
      option.dataset.serviceInterval = tank.serviceIntervalDays || 90;
      option.dataset.lastServiced = tank.lastServicedAt || "";

      tankSelect.appendChild(option);
    });
  } catch (error) {
    console.error("Error fetching tanks:", error);
  }
}

document.getElementById("supplier").addEventListener("change", function () {
  const supplierId = this.value; 
  if (supplierId) {
    loadTanksForSupplier(parseInt(supplierId));
  } else {
    const tankSelect = document.getElementById("tank");
    tankSelect.innerHTML = `<option value="">Select Farm Tank</option>`;
  }
  document.getElementById("total-capacity").textContent = 0;
  document.getElementById("current-volume").textContent = 0;
  document.getElementById("available-space").textContent = 0;
  document.getElementById("temperature").value = "";
  document.getElementById("last_cleaned").value = "";
  document.getElementById("last_sanitized").value = "";
  document.getElementById("last_calibrated").value = "";
  document.getElementById("service_interval").value = 90;
  document.getElementById("last_serviced").value = "";
});

document.addEventListener("DOMContentLoaded", () => {
  const tankSelect = document.getElementById("tank");

  tankSelect.addEventListener("change", () => {
    const selectedOption = tankSelect.options[tankSelect.selectedIndex];

    if (selectedOption && selectedOption.value) {
      const capacity = parseFloat(selectedOption.dataset.capacity);
      const current = parseFloat(selectedOption.dataset.current);
      const available = capacity - current;

      document.getElementById("total-capacity").textContent = capacity;
      document.getElementById("current-volume").textContent = current;
      document.getElementById("available-space").textContent = available;
      document.getElementById("temperature").value = selectedOption.dataset.temperature ;
      document.getElementById("last_cleaned").value = formatDateForInput(selectedOption.dataset.lastCleaned);
      document.getElementById("last_sanitized").value = formatDateForInput(selectedOption.dataset.lastSanitized);
      document.getElementById("last_calibrated").value = formatDateForInput(selectedOption.dataset.lastCalibrated);
      document.getElementById("service_interval").value = selectedOption.dataset.serviceInterval;
      document.getElementById("last_serviced").value = formatDateForInput(selectedOption.dataset.lastServiced);
    } else {
  
      document.getElementById("total-capacity").textContent = 0;
      document.getElementById("current-volume").textContent = 0;
      document.getElementById("available-space").textContent = 0;
      document.getElementById("last_cleaned").value = "";
      document.getElementById("last_sanitized").value = "";
      document.getElementById("last_calibrated").value = "";
      document.getElementById("service_interval").value = 90;
      document.getElementById("last_serviced").value = "";
    }
  });
});

//===============================================Load Approved Milk Lots related to selected Supplier only ===================================//
async function loadMilkLotsForSupplier(supplierId) {
  const query = `
    query ($supplierId: Int!) {
      pendingMilkLotListBySupplier(supplierId: $supplierId) {
        id
        dateCreated
        volumeL
        fatPercent
        proteinPercent
        addedWaterPercent
        status
        volumeL
        supplier {
          id
          user {
            username
          }
        }
        bulkCooler{
          id
          name
        }
        onFarmTank {
          id
          name
        }
      }
    }
  `;

  const variables = { supplierId };

  try {
    const res = await fetch("/graphql/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ query, variables }),
    });

    const result = await res.json();

    if (result.errors) {
      console.error(result.errors);
      renderEmptyMessage("No approved milk lots available");
      return;
    }

    const milkLots = result.data.pendingMilkLotListBySupplier;
    renderMilkLotsTable(milkLots);
    
  } catch (error) {
    console.error("Error fetching milk lots:", error);
    renderEmptyMessage("Error fetching milk lots");
  }
}

function renderMilkLotsTable(milkLots) {
  const tbody = document.querySelector(".milk-lots-table tbody");
  tbody.innerHTML = "";

  if (!milkLots.length) {
    renderEmptyMessage("No approved milk lots available");
    return;
  }

  milkLots.forEach((lot) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${lot.id}</td>
      <td>${lot.dateCreated}</td>
      <td>${lot.supplier.user.username}</td>
      <td>${lot.volumeL}</td>
      <td>${lot.fatPercent}</td>
      <td>${lot.proteinPercent}</td>
      <td>${lot.addedWaterPercent}</td>
      <td class="status-${lot.status.toLowerCase()}">${lot.status}</td>
      <td>${lot.onFarmTank ? lot.onFarmTank.name : (lot.bulkCooler ? lot.bulkCooler.name : '<span class="unassigned">Unassigned</span>')}</td>
      <td>
        <input type="checkbox" class="milk-lot-checkbox" name="selected_lots" 
               value="${lot.id}" 
               data-volume="${lot.volumeL}"
               ${lot.onFarmTank || lot.bulkCooler ? "disabled" : ""}>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function renderEmptyMessage(message) {
  const tbody = document.querySelector(".milk-lots-table tbody");
  tbody.innerHTML = `
    <tr>
      <td colspan="8" class="empty-message">${message}</td>
    </tr>
  `;
}

document.getElementById("supplier").addEventListener("change", function () {
  const supplierId = this.value;
  if (supplierId) {
    loadMilkLotsForSupplier(parseInt(supplierId));
  } else {
    renderEmptyMessage("No supplier selected");
  }
});

//==================================== displaying Volume change for selected milk Lots ===============================================================//
document.addEventListener("DOMContentLoaded", function () {
  const tbody = document.querySelector(".milk-lots-table tbody");
  const selectedVolumeEl = document.getElementById("selected-volume");
  let totalVolume = 0;

  tbody.addEventListener("change", function (event) {
    const checkbox = event.target.closest(".milk-lot-checkbox");
    if (!checkbox) return; 

    const volume = parseFloat(checkbox.dataset.volume);

    if (!isNaN(volume)) {
      if (checkbox.checked) {
        totalVolume += volume;
      } else {
        totalVolume -= volume;
      }
    }

    selectedVolumeEl.textContent = totalVolume.toFixed(2);
  });
});

//============================================== assign selected Milk Lots to OnFarm Tank =================================================//

document.addEventListener("DOMContentLoaded", function () {
    const assignBtn = document.getElementById("assign-btn");

    assignBtn.addEventListener("click", async function () {
        const checkboxes = document.querySelectorAll(".milk-lot-checkbox:checked");
        const selectedLotIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
        const tankSelect = document.getElementById("tank");
        const tankId = tankSelect ? parseInt(tankSelect.value) : null;

        const temperatureCelsius = document.getElementById("temperature")?.value || null;
        const lastCleanedAt = document.getElementById("last_cleaned")?.value || null;
        const lastSanitizedAt = document.getElementById("last_sanitized")?.value || null;
        const lastCalibratedAt = document.getElementById("last_calibrated")?.value || null;
        const lastServicedAt = document.getElementById("last_serviced")?.value || null;
        const serviceIntervalDays = document.getElementById("service_interval")?.value || null;

        if (!tankId) {
            alert("Please select a tank.");
            return;
        }
        if (selectedLotIds.length === 0) {
            alert("Please select at least one milk lot.");
            return;
        }

        const query = `
          mutation AssignLots(
            $tankId: Int!, 
            $lotIds: [Int!]!, 
            $temp: Float, 
            $lastCleanedAt: DateTime, 
            $lastSanitizedAt: DateTime, 
            $lastCalibratedAt: DateTime, 
            $lastServicedAt: DateTime, 
            $serviceIntervalDays: Int  
          ) {
            assignMilkLotsToOnfarmTank(
              tankId: $tankId,
              milkLotIds: $lotIds,
              temperatureCelsius: $temp,
              lastCleanedAt: $lastCleanedAt,
              lastSanitizedAt: $lastSanitizedAt,
              lastCalibrationDate: $lastCalibratedAt,
              lastServicedAt: $lastServicedAt,
              serviceIntervalDays: $serviceIntervalDays
            ) {
              success
              message
            }
          }
        `;

        const variables = {
          tankId: tankId,
          lotIds: selectedLotIds,
          temp: temperatureCelsius ? parseFloat(temperatureCelsius) : null,
          lastCleanedAt: lastCleanedAt || null,
          lastSanitizedAt: lastSanitizedAt || null,
          lastCalibratedAt: lastCalibratedAt || null,
          lastServicedAt: lastServicedAt || null,
          serviceIntervalDays: serviceIntervalDays ? parseInt(serviceIntervalDays) : null
        };

        try {
            const response = await fetch("/graphql/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken")  
                },
                body: JSON.stringify({ query, variables })
            });

            const result = await response.json();
            if (result.data.assignMilkLotsToOnfarmTank.success) {
                alert(result.data.assignMilkLotsToOnfarmTank.message);
                window.location.reload();
            } else {
                alert("Error: " + result.data.assignMilkLotsToOnfarmTank.message);
            }
        } catch (err) {
            console.error(err);
            alert("Something went wrong while assigning lots.");
        }
    });

});

//=================================================== Helper Functions =========================================//
function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
            const cookies = document.cookie.split(";");
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + "=")) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

function formatDateForInput(isoString) {
  if (!isoString) return "";
  const date = new Date(isoString);

  const pad = (n) => (n < 10 ? "0" + n : n);

  const year = date.getFullYear();
  const month = pad(date.getMonth() + 1);
  const day = pad(date.getDate());
  const hours = pad(date.getHours());
  const minutes = pad(date.getMinutes());
  return `${year}-${month}-${day}T${hours}:${minutes}`;
}

</script>
{% endblock %}