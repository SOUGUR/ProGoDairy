{% extends "base.html" %}
{% load static %}

{% block title %}Milk Transfers Management{% endblock %}

{% block content %}
<style>
  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #333;
    font-size: 14px; 
  }

  h1 {
    color: #2c5282;
    margin-bottom: 25px;
    font-weight: 600;
    border-bottom: 2px solid #ebf2f7;
    padding-bottom: 10px;
  }

  .filter-card {
    background-color: #ebf8ff;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }

  .section-title {
    color: #2b6cb0;
    font-weight: 600;
    margin-bottom: 20px;
    font-size: 1.2em;
  }

  .filter-form {
    width: 100%;
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
  }

  .form-group {
    margin-bottom: 15px;
  }

  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #4a5568;
  }

  select, input {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 16px;
    background-color: white;
  }

  .form-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    border-top: 1px solid #cbd5e0;
    padding-top: 20px;
  }

  .btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-primary {
    background-color: #4299e1;
    color: white;
  }

  .btn-primary:hover {
    background-color: #3182ce;
  }

  .btn-secondary {
    background-color: #e2e8f0;
    color: #4a5568;
  }

  .btn-secondary:hover {
    background-color: #cbd5e0;
  }

  .action-buttons {
    display: flex;
    gap: 10px; 
    align-items: center; 
    cursor: pointer;
  }


  .samples-section {
    background-color: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
  }

  .section-header h2 {
    color: #2c5282;
    font-weight: 600;
    margin: 0;
  }

  .results-count {
    color: #4a5568;
    font-size: 0.95em;
  }

  .samples-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }

  .samples-table th {
    background-color: #ebf8ff;
    padding: 16px;
    text-align: left;
    font-weight: 600;
    color: #2b6cb0;
    text-transform: uppercase;
    font-size: 0.85em;
    letter-spacing: 0.5px;
    border-bottom: 2px solid #e2e8f0;
  }

  .samples-table td {
    padding: 16px;
    border-bottom: 1px solid #e2e8f0;
  }

  .samples-table tr:nth-child(even) {
    background-color: #f8fafc;
  }

  .samples-table tr:hover {
    background-color: #ebf8ff;
  }

  .sample-id {
    font-weight: 600;
    color: #2c5282;
  }

  .source-info,
  .vehicle-info {
    line-height: 1.4;
  }

  .source-type,
  .vehicle-id {
    font-size: 0.9em;
    color: #718096;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .source-name,
  .vehicle-name {
    font-weight: 500;
    color: #2d3748;
  }

  .destination,
  .volume {
    color: #2d3748;
    font-weight: 500;
  }

  .received-date,
  .arrival-time {
    text-align: center;
    line-height: 1.4;
  }

  .date {
    font-weight: 500;
    color: #2d3748;
  }

  .time {
    font-size: 0.9em;
    color: #718096;
  }

  .status-badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .status-scheduled {
    background-color: #fef3c7;
    color: #7c2d12;
  }

  .status-in_transit {
    background-color: #e0e7ff;
    color: #4338ca;
  }

  .status-completed {
    background-color: #c6f6d5;
    color: #22543d;
  }

  .btn-view {
    padding: 8px 16px;
    background-color: #4299e1;
    color: white;
    text-decoration: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    transition: background-color 0.2s ease;
    display: inline-block;
  }

  .btn-view:hover {
    background-color: #3182ce;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #718096;
  }

  .empty-icon {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
  }

  .empty-text {
    font-size: 1.1rem;
    font-weight: 500;
    margin-bottom: 8px;
    color: #4a5568;
  }

  .empty-subtext {
    font-size: 0.9rem;
  }

/* -------------------------------------------- modal style for milk transfer view ----------------------------------------- */
.modal {
    display: none; 
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.4); 
    backdrop-filter: blur(2px);
    animation: fadeIn 0.3s ease-out;
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    width: 90%;
    max-width: 500px;
    border-top: 6px solid #1b10b9; 
    animation: slideIn 0.3s ease-out;
    position: relative;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    background: none;
    border: none;
    line-height: 1;
    opacity: 0.8;
    transition: color 0.3s ease, transform 0.2s ease;
}

.close:hover,
.close:focus {
    color: #f40f0f;
    transform: scale(1.2);
    opacity: 1;
}


.modal-content h2 {
    color: #1e40af;
    font-size: 1.5rem;
    margin: 0 0 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #eff6ff;
    font-family: 'Poppins', sans-serif;
    font-weight: 600;
}

#transferDetails {
    font-size: 14px;
    color: #060606;
    line-height: 1.7;
}

#transferDetails p {
    margin: 0.6rem 0;
    display: flex;
    flex-wrap: wrap;
}

#transferDetails strong {
    min-width: 120px;
    color: #1e40af;
    font-weight: 600;
}

#transferDetails span {
    flex: 1;
}

@media (max-width: 600px) {
    .modal-content {
        width: 95%;
        margin: 10% auto;
        padding: 1.5rem;
    }
    .modal-content h2 {
        font-size: 1.3rem;
    }
    #transferDetails {
        font-size: 13px;
    }
}

#editForm label {
  display: block;        
  margin-top: 15px;        
  margin-bottom: 5px;    
  font-weight: bold;
}

#editForm input {
  display: block;         
  width: 100%;          
  padding: 8px 10px;      
  margin-bottom: 10px;  
  box-sizing: border-box;  
  border: 1px solid #ccc;
  border-radius: 4px;
}

#editForm button[type="submit"] {
    background-color: #1b10b9;          
    color: white;
    border: none;
    padding: 12px 24px;
    font-size: 15px;
    font-weight: 600;
    font-family: 'Poppins', sans-serif;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.03s ease;
    margin-top: 1rem;
    width: 100%;                       
}


</style>
<div class="container">
  <h1>Milk Transfers</h1>

  <!-- Filter Section -->
  <div class="filter-card">
    <div class="section-title">Filter milk-transfers</div>
    <form class="filter-form">
      <div class="form-grid">
        <div class="form-group">
          <label for="start_date">From Date</label>
          <input type="datetime-local" id="start_date" name="start_date">
        </div>

        <div class="form-group">
          <label for="end_date">To Date</label>
          <input type="datetime-local" id="end_date" name="end_date">
        </div>

        <div class="form-group">
          <label for="source_type">Source Type</label>
          <select id="source_type" name="source_type">
            <option value="">All Sources</option>
            <option value="bulk_cooler">Bulk Cooler</option>
            <option value="on_farm_tank">On-Farm Tank</option>
            <option value="can_collection">Can Collection</option>
          </select>
        </div>

        <div class="form-group">
          <label for="status">Transfer Status</label>
          <select id="status" name="status">
            <option value="">All Statuses</option>
            <option value="scheduled">Scheduled</option>
            <option value="in_transit">In Transit</option>
            <option value="completed">Completed</option>
          </select>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Apply Filters</button>
        <button type="reset" class="btn btn-secondary">Clear Filters</button>
      </div>
    </form>
  </div>

  <!-- Transfers Table -->
  <div class="samples-section">
    <div class="section-header">
      <h2>Transfer Records</h2>
      <div class="results-count">
        Showing <strong>{{ transfers.count }}</strong> transfers
      </div>
    </div>

    <table class="samples-table">
      <thead>
        <tr>
          <th>Transfer ID</th>
          <th>Source</th>
          <th>Vehicle</th>
          <th>Destination</th>
          <th>Volume (L)</th>
          <th>Status</th>
          <th>Remarks</th>
          <th>Transfer Date</th>
          <th>Arrival Time</th>
          <th>Actions</th>
          <th>Update</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
</div>

<!-------------------------------------------- Modal for viewing details of Milk Transfer ----------------------------------------------->
<div id="transferModal" class="modal hidden">
  <div class="modal-content">
    <span id="closeModal" class="close">&times;</span>
    <h2>Milk Transfer Details</h2>
    <div id="transferDetails"></div>
  </div>
</div>

<!---------------------------------------------Modal for editing/updating the milk transfer ------------------------------------->>
<div id="editModal" class="modal" style="display: none;">
  <div class="modal-content">
    <span id="closeUpdateModal" class="close">&times;</span>
    <h2>Update Milk Transfer</h2>
    <form id="editForm">
      <label for="departureWeight">Departure Weight (kg)</label>
      <input 
        type="number" 
        id="departureWeight" 
        step="0.01" 
        min="0"
        placeholder="e.g. 1250.50"
      />

      <input type="hidden" id="transferId" />
      <label for="arrivalDatetime">Arrival DateTime:</label>
      <input type="datetime-local" id="arrivalDatetime" required />

      <label for="arrivalWeight">Arrival Weight (kg)</label>
      <input 
        type="number" 
        id="arrivalWeight" 
        step="0.01" 
        min="0"
        placeholder="e.g. 1245.75"
      />

      <label for="updateRemark">Remark</label>
      <input type="text" id="updateRemark" required />
      <button type="submit">Update</button>
    </form>
  </div>
</div>

<script src="{% static 'notifications/js/notify.js' %}"></script>
<script>

//================================================= Populate the table based on filters selected ====================================================================//
const tableBody = document.querySelector(".samples-table tbody");
const filterForm = document.querySelector(".filter-form");
const statusSelect = document.getElementById("status");

filterForm.addEventListener("submit", async (e) => {
  e.preventDefault(); 
  const status = statusSelect.value; 
  const transfers = await fetchMilkTransfers(status);
  populateTable(transfers);
});

filterForm.addEventListener("reset", async (e) => {
  setTimeout(async () => {
    statusSelect.value = ""; 
    const transfers = await fetchMilkTransfers();
    populateTable(transfers);
  }, 0);
});


async function fetchMilkTransfers(status = "") {
  const query = `
    query ($status: String) {
      milkTransfers(status: $status) {
        id
        status
        transferDate
        arrivalDatetime
        totalVolume
        remarks
        vehicle {
          name
          vehicleId
        }
        destination {
          name
        }
        bulkCooler {
        createdAt
          name
        }
        onFarmTank {
          createdAt
          supplier {
            user {
              username
            }
          }
        }
        canCollection {
          createdAt
          name
        }
      }
    }
  `;

  const variables = { status: status || null };

  const res = await fetch("/graphql/", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ query, variables }),
  });

  const result = await res.json();
  return result.data.milkTransfers;
}

//================= Helper function to convert dateTime to date ===================//
const formatDate = (dateString) => {
  if (!dateString) return "";
  return new Date(dateString).toISOString().split('T')[0];  
};

function populateTable(transfers) {
  tableBody.innerHTML = "";

  if (transfers.length === 0) {
    tableBody.innerHTML = `
      <tr>
        <td colspan="9" class="empty-state">No milk transfers found</td>
      </tr>
    `;
    return;
  }

  transfers.forEach(t => {
    const bulkCoolerName = t.bulkCooler?.name;
    const bulkCoolerDate = t.bulkCooler ? formatDate(t.bulkCooler.createdAt) : "";
    const onFarmTankName = t.onFarmTank?.supplier?.user?.username ? t.onFarmTank.supplier.user.username + "'s Tank" : "";
    const onFarmTankDate = t.onFarmTank ? formatDate(t.onFarmTank.createdAt) : "";
    const canCollectionName = t.canCollection ? `Can Collection #${t.canCollection.name}` : "";
    const canCollectionDate = t.canCollection ? formatDate(t.canCollection.createdAt) : "";

    const source =
      (bulkCoolerName ? `${bulkCoolerName}<br><small style="color: red;">(${bulkCoolerDate})</small>` : null)
      || (onFarmTankName ? `${onFarmTankName}<br><small style="color: red;">(${onFarmTankDate})</small>` : null)
      || (canCollectionName ? `${canCollectionName}<br><small style="color: red;">(${canCollectionDate})</small>` : "Unknown");


    const vehicle = t.vehicle ? `${t.vehicle.name} (${t.vehicle.vehicleId})` : "Unassigned";
    const destination = t.destination?.name || "-";
    const milkTransferStatus = t.status || "-";
    const volume = t.totalVolume?.toFixed(2) || "0.00";
    function formatUTCDateTime(isoString) {
      if (!isoString) return "-";

      const date = new Date(isoString);

      const datePart = date.toLocaleDateString('en-GB', {
        timeZone: 'UTC',
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });

      const timePart = date.toLocaleTimeString('en-US', {
        timeZone: 'UTC',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      });

      return `${datePart}<br>${timePart}`;
    }
    const transferDate = formatUTCDateTime(t.transferDate);
    const arrivalTime = formatUTCDateTime(t.arrivalDatetime);

    const row = `
      <tr>
        <td>${t.id}</td>
        <td>${source}</td>
        <td>${vehicle}</td>
        <td>${destination}</td>
        <td>${volume} L</td>
        <td>${milkTransferStatus}</td>
        <td>${t.remarks || "-"}</td>
        <td>${transferDate}</td>
        <td>${arrivalTime}</td>
        <td>
          <div class="action-buttons">
            <a onclick = "loadTransfer(${t.id});" title="View Details" class="btn-view">
              <i class="fas fa-eye"></i>
            </a>
          </div>
        </td>
        <td>
          <div class="action-buttons">
            <a onclick = "editTransfer(${t.id});" title="Edit Transfer" class="btn-edit">
              <i class="fas fa-edit"></i>
            </a>
          </div>
        </td>
      </tr>
    `;
    tableBody.insertAdjacentHTML("beforeend", row);
  });
}

document.addEventListener("DOMContentLoaded", async () => {
  const transfers = await fetchMilkTransfers();
  populateTable(transfers);
});

//--------------------------------------------------- function to view Milk Transfer modal ------------------------------------------------ //
//----------function to fetch Milk Transfer by ID
async function fetchMilkTransferById(id) {
  const query = `
    query($id: Int!) {
      milkTransferById(id: $id) {
        id
        sourceType
        transferDate
        arrivalDatetime
        status
        departureWeightKg  
        arrivalWeightKg    
        totalVolume
        remarks
        vehicle { id name vehicleId }
        destination { id name }
        bulkCooler { id name }
        onFarmTank { id supplier { user { username } } }
        canCollection { id name }
      }
    }
  `;

  const response = await fetch("/graphql/", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ query, variables: { id } }),
  });

  const result = await response.json();
  return result.data.milkTransferById;
}

function showTransferDetails(t) {
  let source = "Unknown";
  if (t.bulkCooler) source = `Bulk Cooler - ${t.bulkCooler.name}`;
  else if (t.onFarmTank) source = `On-Farm Tank - ${t.onFarmTank.supplier.user.username}`;
  else if (t.canCollection) source = `Can Collection #${t.canCollection.name}`;

  const detailsHTML = `
    <p><strong>ID:</strong> ${t.id}</p>
    <p><strong>Status:</strong> ${t.status}</p>
    <p><strong>Source:</strong> ${source}</p>
    <p><strong>Destination:</strong> ${t.destination ? t.destination.name : "-"}</p>
    <p><strong>Vehicle:</strong> ${t.vehicle ? t.vehicle.name : "Unassigned"}</p>
    <p><strong>Volume:</strong> ${t.totalVolume || 0} L</p>
    <p><strong>Transfer Date:</strong> ${new Date(t.transferDate).toLocaleString()}</p>
    <p><strong>Arrival Time:</strong> ${t.arrivalDatetime ? new Date(t.arrivalDatetime).toLocaleString() : "-"}</p>
    <p><strong>Remarks:</strong> ${t.remarks || "-"}</p>
  `;

  document.getElementById("transferDetails").innerHTML = detailsHTML;

  const modal = document.getElementById("transferModal");
  modal.style.display = "block";
}

document.getElementById("closeModal").onclick = function () {
  document.getElementById("transferModal").style.display = "none";
};
window.onclick = function (event) {
  const modal = document.getElementById("transferModal");
  if (event.target == modal) modal.style.display = "none";
};

async function loadTransfer(id) {
  const transfer = await fetchMilkTransferById(id);
  if (transfer) {
    showTransferDetails(transfer);
  } else {
    alert("Transfer not found!");
  }
}

//======================================================== Update Milk Transfer =====================================================//
async function updateMilkTransfer(id, arrivalDatetime, remarks, departureWeightKg, arrivalWeightKg) {
  const mutation = `
    mutation UpdateMilkTransfer($input: MilkTransferUpdateInput!) {
      updateMilktransfer(input: $input) {
        id
        arrivalDatetime
        remarks
        departureWeightKg
        arrivalWeightKg
      }
    }
  `;

  const variables = {
    input: {
      id: id,
      arrivalDatetime: arrivalDatetime,
      remarks: remarks,
      departureWeightKg: departureWeightKg,  
      arrivalWeightKg: arrivalWeightKg     
    },
  };

  const response = await fetch("/graphql/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({ query: mutation, variables }),
  });

  const result = await response.json();
  console.log(result);
  return result.data.updateMilktransfer;
}

async function editTransfer(id) {
  const transfer = await fetchMilkTransferById(id);
  if (!transfer) {
    alert("Transfer not found!");
    return;
  }

  document.getElementById("transferId").value = transfer.id;

  if (transfer.arrivalDatetime) {
    const localArrival = new Date(transfer.arrivalDatetime).toLocaleString('sv-SE', {
      timeZone: 'UTC',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
    document.getElementById("arrivalDatetime").value = localArrival;
  } else {
    document.getElementById("arrivalDatetime").value = "";
  }

  document.getElementById("departureWeight").value = transfer.departureWeightKg ?? "";
  document.getElementById("arrivalWeight").value = transfer.arrivalWeightKg ?? "";

  document.getElementById("updateRemark").value = transfer.remarks ?? "";
  document.getElementById("editModal").style.display = "block";
}

document.getElementById("closeUpdateModal").onclick = function () {
  document.getElementById("editModal").style.display = "none";
};

document.getElementById("editForm").onsubmit = async function (e) {
  e.preventDefault();
  const id = parseInt(document.getElementById("transferId").value);
  const arrivalDatetime = document.getElementById("arrivalDatetime").value;
  const remarks = document.getElementById("updateRemark").value;

  const departureWeightRaw = document.getElementById("departureWeight").value;
  const arrivalWeightRaw = document.getElementById("arrivalWeight").value;

  const departureWeight = departureWeightRaw ? parseFloat(departureWeightRaw) : null;
  const arrivalWeight = arrivalWeightRaw ? parseFloat(arrivalWeightRaw) : null;

  const updated = await updateMilkTransfer(id, arrivalDatetime, remarks, departureWeight, arrivalWeight);

  if (updated) {
    showNotification(`Milk Transfer ID ${id} updated with arrival time ${arrivalDatetime} successfully!`, 'transfer', 4000);
    document.getElementById("editModal").style.display = "none";
    const transfers = await fetchMilkTransfers();
    populateTable(transfers);
  } else {
    showNotification("Failed to update Milk Transfer!", 'warning', 6000);
  }
};

</script>

{% endblock %}