{% extends "base.html" %}
{% load static %}

{% block title %}Milk Transfer Management{% endblock %}

{% block content %}
<style>
  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #333;
    font-size: 14px; 
  }
  
  h1 {
    color: #2c5282;
    margin-bottom: 25px;
    font-weight: 600;
    border-bottom: 2px solid #ebf2f7;
    padding-bottom: 10px;
  }
  
  .form-section {
    background-color: #ebf8ff;
    border-radius: 8px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  
  .section-title {
    color: #2b6cb0;
    font-weight: 600;
    margin-bottom: 20px;
    font-size: 1.2em;
  }
  
  .transfer-form {
    width: 100%;
  }
  
  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
  }
  
  .form-group {
    margin-bottom: 15px;
  }
  
  .form-group.full-width {
    grid-column: 1 / -1;
  }
  
  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #4a5568;
  }
  
  select, input, textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #e2e8f0;
    border-radius: 4px;
    font-size: 16px;
    background-color: white;
    box-sizing: border-box;
  }
  
  textarea {
    resize: vertical;
    min-height: 80px;
  }
  
  .volume-display {
    background-color: #f0fff4;
    border: 1px solid #c6f6d5;
    border-radius: 4px;
    padding: 12px;
    text-align: center;
    font-weight: 600;
    color: #2b6cb0;
    font-size: 16px;
  }
  
  .form-actions {
    position: fixed;
    bottom: 500px;
    right: 20px;  
    z-index: 1000; 
  }
  
  .btn {
    padding: 12px 24px;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  
  .btn-primary {
    background-color: #4299e1;
    color: white;
  }
  
  .btn-primary:hover {
    background-color: #3182ce;
  }
  
  .transfers-section {
    background-color: white;
    border-radius: 8px;
    padding: 25px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  
  .section-header {
    margin-bottom: 20px;
  }
  
  .section-header h2 {
    color: #2c5282;
    font-weight: 600;
  }
  
  .data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  
  .data-table th {
    background-color: #ebf8ff;
    padding: 15px;
    text-align: left;
    font-weight: 600;
    color: #2b6cb0;
    text-transform: uppercase;
    font-size: 0.85em;
    letter-spacing: 0.5px;
  }
  
  .data-table td {
    padding: 15px;
    border-bottom: 1px solid #e2e8f0;
  }
  
  .data-table tr:nth-child(even) {
    background-color: #f8fafc;
  }
  
  .data-table tr:hover {
    background-color: #ebf8ff;
  }
  
  .status-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.85em;
    font-weight: 500;
  }
  
  .status-scheduled {
    background-color: #feebc8;
    color: #7b341e;
  }
  
  .status-in_transit {
    background-color: #bee3f8;
    color: #2c5282;
  }
  
  .status-completed {
    background-color: #c6f6d5;
    color: #22543d;
  }
  
  .action-buttons {
    display: flex;
    gap: 8px;
  }
  
  .btn-icon {
    padding: 8px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  
  .view-btn {
    background-color: #4299e1;
    color: white;
  }
  
  .view-btn:hover {
    background-color: #3182ce;
  }
  
  .edit-btn {
    background-color: #68d391;
    color: white;
  }
  
  .edit-btn:hover {
    background-color: #48bb78;
  }
  
  .empty-state {
    text-align: center;
    padding: 30px;
    color: #718096;
    background-color: #f8fafc;
    border-radius: 4px;
  }
</style>
<div class="container">
  <h1>Milk Transfer Management</h1>
  
  <!------------------------------- Milk Transfer Creation Form ------------------------->
  <div class="form-section">
    <div class="section-title">Create New Milk Transfer</div>
    
    <form class="transfer-form">
      <div class="form-grid">
        <div class="form-group">
          <label for="route">Select Route</label>
          <select id="route" name="route" required>
            <option value="">Select route</option>
          </select>
        </div>
        <!-- Source Selection for milk transfer -->
        <div class="form-group">
          <label for="source_type">Source Type</label>
          <select id="source_type" name="source_type" required>
            <option value="">Select Source Type</option>
            <option value="bulk_cooler">Bulk Cooler</option>
            <option value="on_farm_tank">On-Farm Tank</option>
            <option value="can_collection">Can Collection</option>
          </select>
        </div>

        <div class="form-group" id="date_field" style="display: none;">
          <label for="collection_date">Collection Date</label>
          <input type="date" id="collection_date" name="collection_date">
        </div>

        <div class="form-group">
          <label for="pooled_milk_lots_source">Pooled MilkLot Source</label>
          <select id="pooled_milk_lots_source" name="pooled_milk_lots_source" required>
            <option value="">Select Pooled MilkLot Source</option>
          </select>
        </div>
        
        <!------------------------------------- select Vehicle which is availble  --------------------------------------------->
        <div class="form-group">
          <label for="vehicle">Vehicle</label>
          <select id="vehicle" name="vehicle" required>
            <option value="">Select Vehicle</option>
          </select>
        </div>
        
        <!------------------------ Destination is the plant name that vehicle has to reach --------------------------->
        <div class="form-group">
          <label for="destination">Destination</label>
          <select id="destination" name="destination" required>
            <option value="">Select Destination</option>
          </select>
        </div>


        <div class="form-group">
          <label for="status">Status</label>
          <select id="status" name="status" required>
            <option value="scheduled">Scheduled</option>
            <option value="in_transit">In Transit</option>
            <option value="completed">Completed</option>
          </select>
        </div>

        
        <!-- Date/Time Fields -->
        <div class="form-group">
          <label for="transfer_date">Transfer Date & Time</label>
          <input type="datetime-local" id="transfer_date" name="transfer_date">
        </div>
        
        <div class="form-group">
          <label for="arrival_datetime">Arrival Date & Time</label>
          <input type="datetime-local" id="arrival_datetime" name="arrival_datetime">
        </div>

        <!-- Volume Display -->
        <div class="form-group">
          <label>Estimated Volume</label>
          <div class="volume-display">
            <span id="estimated_volume">0.00</span> L
          </div>
        </div>
        
        <!-- Remarks -->
        <div class="form-group full-width">
          <label for="remarks">Remarks</label>
          <textarea id="remarks" name="remarks" rows="3" 
                    placeholder="Add any additional notes or instructions"></textarea>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Create Transfer</button>
      </div>
    </form>
  </div>
  
  <!-- Milk Transfers Table -->
  <div class="transfers-section">
    <div class="section-header">
      <h2>Recent Milk Transfers</h2>
    </div>
    
    <table class="data-table">
      <thead>
        <tr>
          <th>Transfer ID</th>
          <th>Source</th>
          <th>Vehicle</th>
          <th>Cooperative Society</th>
          <th>Destination</th>
          <th>Volume (L)</th>
          <th>Status</th>
          <th>Transfer Date</th>
          <th>Arrival Time</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
</div>
<script src="{% static 'notifications/js/notify.js' %}"></script>
<script>
//==================================================== Load Routes =====================================================//
  document.addEventListener("DOMContentLoaded", function () {
  const routeSelect = document.getElementById("route");
  const query = `
    query {
      allRoutes {
        id
        name
      }
    }
  `;

  fetch("/graphql/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({ query })
  })
    .then(response => response.json())
    .then(data => {
      const routes = data.data.allRoutes;
      routes.forEach(route => {
        const option = document.createElement("option");
        option.value = route.id;
        option.textContent = route.name;
        routeSelect.appendChild(option);
      });
    })
    .catch(error => console.error("Error loading routes:", error));
});

//======================================================= Load plant names that is destination ======================================================//
async function loadPlants() {
    const query = `
      query {
        plants {
          id
          name
        }
      }
    `;

    try {
      const response = await fetch("/graphql/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ query }),
      });

      const result = await response.json();
      const plants = result.data.plants;

      const select = document.getElementById("destination");

      plants.forEach(plant => {
        const option = document.createElement("option");
        option.value = plant.id;  
        option.textContent = plant.name;  
        select.appendChild(option);
      });
    } catch (error) {
      console.error("Error fetching plants:", error);
    }
  }

  document.addEventListener("DOMContentLoaded", loadPlants);

//===================================================== show CanCollection if date is selected ====================================================//
document.getElementById("source_type").addEventListener("change", function () {
    let dateField = document.getElementById("date_field");
    if (this.value === "can_collection") {
      dateField.style.display = "block"; 
    } else {
      dateField.style.display = "none"; 
    }
  });

//======================================================= Load Source of Pooled Milk Lots =====================================================//
const routeSelect = document.getElementById("route");
const sourceTypeSelect = document.getElementById("source_type");
const dateField = document.getElementById("date_field");
const collectionDateInput = document.getElementById("collection_date");
const pooledSourceSelect = document.getElementById("pooled_milk_lots_source");
const estimatedVolumeSpan = document.getElementById("estimated_volume");

const GET_ONFARM_TANKS = `
  query OnFarmTanks($routeId: Int!) {
    onfarmTanksByRoute(routeId: $routeId) {
      id
      name
      currentVolumeLiters
      supplier { user { username } }
      createdAt
    }
  }
`;

const GET_BULK_COOLERS = `
  query BulkCoolers($routeId: Int!) {
    bulkCoolersByRoute(routeId: $routeId) {
      id
      name
      currentVolumeLiters
      capacityLiters
      createdAt
    }
  }
`;

const GET_CAN_COLLECTIONS = `
  query CanCollections($routeId: Int!, $createdDate: Date!) {
    canCollectionsByDate(routeId: $routeId, createdDate: $createdDate) {
      id
      name
      totalVolumeLiters
      createdAt
    }
  }
`;

sourceTypeSelect.addEventListener("change", async function () {
  const routeId = routeSelect.value;
  const sourceType = this.value;

  // Show/hide date field
  if (sourceType === "can_collection") {
    dateField.style.display = "block";
  } else {
    dateField.style.display = "none";
    collectionDateInput.value = "";
  }

  if (!routeId || !sourceType) return;

  let query, variables;

  if (sourceType === "on_farm_tank") {
    query = GET_ONFARM_TANKS;
    variables = { routeId: parseInt(routeId) };
  } else if (sourceType === "bulk_cooler") {
    query = GET_BULK_COOLERS;
    variables = { routeId: parseInt(routeId) };
  } else if (sourceType === "can_collection") {
    const createdDate = collectionDateInput.value;
    if (!createdDate) {
      pooledSourceSelect.innerHTML = `<option value="">Select date first</option>`;
      return;
    }
    query = GET_CAN_COLLECTIONS;
    variables = { routeId: parseInt(routeId), createdDate };
  }

  try {
    const data = await fetchGraphQL(query, variables);
    populateSources(sourceType, data);
  } catch (err) {
    console.error("Error loading sources:", err);
    pooledSourceSelect.innerHTML = `<option value="">Failed to load</option>`;
  }
});

collectionDateInput.addEventListener("change", async function () {
  if (sourceTypeSelect.value === "can_collection") {
    sourceTypeSelect.dispatchEvent(new Event("change"));
  }
});

function populateSources(sourceType, data) {
  pooledSourceSelect.innerHTML = `<option value="">Select Pooled MilkLot Source</option>`;
  estimatedVolumeSpan.textContent = "0.00"; 

  let items = [];
  if (sourceType === "on_farm_tank") {
    items = data.onfarmTanksByRoute || [];
    items.forEach(tank => {
      let createdDate = new Date(tank.createdAt).toISOString().split('T')[0];
      pooledSourceSelect.insertAdjacentHTML(
        "beforeend",
        `<option value="${tank.id}" data-volume="${tank.currentVolumeLiters || 0}">
          ${tank.name} (${tank.supplier?.user?.username || "Unknown"}) <small>(dateLog: ${createdDate})</small>
        </option>`
      );
    });
  } else if (sourceType === "bulk_cooler") {
    items = data.bulkCoolersByRoute || [];
    items.forEach(cooler => {
      let createdDate = new Date(cooler.createdAt).toISOString().split('T')[0];
      pooledSourceSelect.insertAdjacentHTML(
        "beforeend",
        `<option value="${cooler.id}" data-volume="${cooler.currentVolumeLiters || 0}">
          ${cooler.name} (Cap: ${cooler.capacityLiters}L) <small>(dateLog: ${createdDate})</small>
        </option>`
      );
    });
  } else if (sourceType === "can_collection") {
    items = data.canCollectionsByDate || [];
    items.forEach(col => {
      pooledSourceSelect.insertAdjacentHTML(
        "beforeend",
        `<option value="${col.id}" data-volume="${col.totalVolumeLiters || 0}">
          ${col.name} - ${col.totalVolumeLiters}L
        </option>`
      );
    });
  }
}

pooledSourceSelect.addEventListener("change", function () {
  const selectedOption = this.options[this.selectedIndex];
  const volume = selectedOption?.dataset.volume || 0;
  estimatedVolumeSpan.textContent = parseFloat(volume).toFixed(2);
});

async function fetchGraphQL(query, variables = {}) {
  const response = await fetch("/graphql/", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ query, variables }),
  });
  const result = await response.json();
  if (result.errors) {
    throw new Error(result.errors.map(e => e.message).join(", "));
  }
  return result.data;
}


//========================================================= Get Vehicles by Route ============================================================//
const vehicleSelect = document.getElementById("vehicle");

const GET_AVAILABLE_VEHICLES = `
  query AvailableVehicles($routeId: Int!) {
    availableVehiclesByRoute(routeId: $routeId) {
      id
      name
      vehicleId
      capacityLiters
      distributor { 
        user {
            username
        }
      }
    }
  }
`;

routeSelect.addEventListener("change", async function () {
  const routeId = this.value;
  if (!routeId) {
    vehicleSelect.innerHTML = `<option value="">Select Vehicle</option>`;
    return;
  }

  try {
    const data = await fetchGraphQL(GET_AVAILABLE_VEHICLES, { routeId: parseInt(routeId) });
    populateVehicles(data.availableVehiclesByRoute);
  } catch (err) {
    console.error("Error loading vehicles:", err);
    vehicleSelect.innerHTML = `<option value="">Failed to load vehicles</option>`;
  }
});

function populateVehicles(vehicles) {
  vehicleSelect.innerHTML = `<option value="">Select Vehicle</option>`;

  if (!vehicles || vehicles.length === 0) {
    vehicleSelect.innerHTML = `<option value="">No available vehicles</option>`;
    return;
  }

  vehicles.forEach(v => {
    vehicleSelect.insertAdjacentHTML(
      "beforeend",
      `<option value="${v.id}">
        ${v.name || v.vehicleId} 
        (${v.capacityLiters ? v.capacityLiters + "L" : "Unknown capacity"})
        ${v.distributor?.name ? " - " + v.distributor.name : ""}
      </option>`
    );
  });
}

async function fetchGraphQL(query, variables = {}) {
  const response = await fetch("/graphql/", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ query, variables }),
  });
  const result = await response.json();
  if (result.errors) {
    throw new Error(result.errors.map(e => e.message).join(", "));
  }
  return result.data;
}

//=============================================================== Create a Milk Transfer instance ==========================================//
document.querySelector(".transfer-form").addEventListener("submit", async function(e) {
  e.preventDefault();
  const routeId = document.getElementById("route").value;
  const sourceType = document.getElementById("source_type").value;
  const pooledMilkLotId = parseInt(document.getElementById("pooled_milk_lots_source").value);
  const vehicleId = parseInt(document.getElementById("vehicle").value);
  const destinationId = parseInt(document.getElementById("destination").value);
  const status = document.getElementById("status").value;
  const transferDate = document.getElementById("transfer_date").value;
  const arrivalDatetime = document.getElementById("arrival_datetime").value || null;
  const remarks = document.getElementById("remarks").value;

  const mutation = `
    mutation CreateMilkTransfer($input: MilkTransferInput!) {
      createMilkTransfer(input: $input) {
        id
        status
        totalVolume
        transferDate
        arrivalDatetime
        vehicle { id }
        destination { id name }
      }
    }
  `;

  const variables = {
    input: {
      sourceType: sourceType,
      sourceId: pooledMilkLotId,
      vehicleId: vehicleId || null,
      destinationId: destinationId || null,
      status: status,
      remarks: remarks || null,
      transferDate: transferDate || null,
      arrivalDatetime: arrivalDatetime || null
    }
  };

  try {
    const res = await fetch("/graphql/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ query: mutation, variables })
    });

    const result = await res.json();
    if (result.errors) {
      console.error("GraphQL Errors:", result.errors);
      showNotification("Failed to create transfer: " + result.errors[0].message, 'error', 1800);
      return;
    }

    const transfer = result.data.createMilkTransfer;
    showNotification(`You scheduled a Milk Transfer ${transfer.id} with status ${transfer.status} successfully`, 'success', 4000);
    
    e.target.reset();
  } catch (error) {
    console.error("Error creating transfer:", error);
   showNotification('You encountered an error while creating Milk Transfer', 'error', 1800);
  }
});

//============================================== Populate the table with Scheduled or In-transit Milk Transfers ==========================================//
const tableBody = document.querySelector(".data-table tbody");
const query = `
  query {
    milkTransfers(status: "scheduled") {
      id
      status
      transferDate
      arrivalDatetime
      totalVolume
      vehicle {
        id
        name
        vehicleId
        route {
          name
        }
      }
      destination {
        id
        name
      }
      bulkCooler {
        name
        createdAt
      }
      onFarmTank {
        createdAt
        supplier {
          user {
            username
          }
        }
      }
      canCollection {
        id
      }
    }
  }
`;

//======== helper function to get date from dateTime object ================//
const formatDate = (dateString) => {
  if (!dateString) return "";
  return new Date(dateString).toISOString().split('T')[0];  
};

fetch("/graphql/", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    "Accept": "application/json",
  },
  body: JSON.stringify({ query })
})
.then(res => res.json())
.then(result => {
  const transfers = result.data.milkTransfers;

  tableBody.innerHTML = ""; 

  if (transfers.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="9" class="empty-state">No milk transfers found</td></tr>`;
    return;
  }

  transfers.forEach(transfer => {
    const bulkCoolerName = transfer.bulkCooler?.name;
    const bulkCoolerDate = transfer.bulkCooler ? formatDate(transfer.bulkCooler.createdAt) : "";
    const onFarmTankName = transfer.onFarmTank?.supplier?.user?.username ? transfer.onFarmTank.supplier.user.username + "'s Tank" : "";
    const onFarmTankDate = transfer.onFarmTank ? formatDate(transfer.onFarmTank.createdAt) : "";
    const canCollectionName = transfer.canCollection ? `Can Collection #${transfer.canCollection.id}` : "";
    const canCollectionDate = transfer.canCollection ? formatDate(transfer.canCollection.createdAt) : "";

    const source =
      (bulkCoolerName ? `${bulkCoolerName}<br><small style="font-size: smaller; color: red;">(${bulkCoolerDate})</small>` : null)
      || (onFarmTankName ? `${onFarmTankName}<br><small style="font-size: smaller; color: red;">(${onFarmTankDate})</small>` : null)
      || (canCollectionName ? `${canCollectionName}<br><small style="font-size: smaller; color: red;">(${canCollectionDate})</small>` : "Unknown");


    const vehicle = transfer.vehicle 
                    ? `${transfer.vehicle.name} (${transfer.vehicle.vehicleId})` 
                    : "Not assigned";
    const milkCooperative = transfer.vehicle 
                    ? `${transfer.vehicle.route.name}` 
                    : "-";

    const destination = transfer.destination?.name || "-";
    const totalVolume = transfer.totalVolume || 0;
    const status = transfer.status?.charAt(0).toUpperCase() + transfer.status?.slice(1);
    const transferDate = new Date(transfer.transferDate).toLocaleString();
    const arrivalTime = transfer.arrivalDatetime ? new Date(transfer.arrivalDatetime).toLocaleString() : "-";

    const row = `
      <tr>
        <td>${transfer.id}</td>
        <td>${source}</td>
        <td>${vehicle}</td>
        <td>${milkCooperative}</td>
        <td>${destination}</td>
        <td>${totalVolume}</td>
        <td><span class="status-badge status-${transfer.status}">${status}</span></td>
        <td>${transferDate}</td>
        <td>${arrivalTime}</td>
        <td>
          <div class="action-buttons">
            <button class="btn-icon view-btn" title="View Details"><i class="fas fa-eye"></i></button>
            <button class="btn-icon edit-btn" title="Edit Transfer"><i class="fas fa-edit"></i></button>
          </div>
        </td>
      </tr>
    `;
    tableBody.insertAdjacentHTML("beforeend", row);
  });
})
.catch(error => {
  console.error("Error fetching milk transfers:", error);
  tableBody.innerHTML = `<tr><td colspan="9" class="empty-state">Error loading data</td></tr>`;
});
</script>
{% endblock %}