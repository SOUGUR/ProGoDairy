{% extends "base.html" %}
{% load static %}

{% block title %}CIP Records by Route{% endblock %}

{% block content %}

<style>
  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #333;
    font-size: 14px; 
  }

  h1 {
    color: #2c5282;
    margin-bottom: 25px;
    font-weight: 600;
    border-bottom: 2px solid #ebf2f7;
    padding-bottom: 10px;
  }

  .filter-card {
    background-color: #ebf8ff;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }

  .section-title {
    color: #2b6cb0;
    font-weight: 600;
    margin-bottom: 20px;
    font-size: 1.2em;
  }

  .filter-form {
    width: 100%;
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
  }

  .form-group {
    margin-bottom: 15px;
  }

  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #4a5568;
  }

  select, input {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 16px;
    background-color: white;
  }

  .form-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    border-top: 1px solid #cbd5e0;
    padding-top: 20px;
  }

    .apply-filter {
    width:100%;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    background-color: #4299e1;
    color: white;
    margin-top: 6px;
  }

   .apply-filter:hover {
    background-color: #3182ce;
  }

  .btn {
    padding: 8px 20px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-primary {
    background-color: #4299e1;
    color: white;
  }

  .btn-primary:hover {
    background-color: #3182ce;
  }

  .btn-secondary {
    background-color: #e2e8f0;
    color: #4a5568;
  }

  .btn-secondary:hover {
    background-color: #cbd5e0;
  }

  .action-buttons {
    display: flex;
    gap: 10px; 
    align-items: center; 
    cursor: pointer;
  }

  .samples-section {
    background-color: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
  }

  .section-header h2 {
    color: #2c5282;
    font-weight: 600;
    margin: 0;
  }

  .results-count {
    color: #4a5568;
    font-size: 0.95em;
  }

  .samples-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }

  .samples-table th {
    background-color: #ebf8ff;
    padding: 16px;
    text-align: left;
    font-weight: 600;
    color: #2b6cb0;
    text-transform: uppercase;
    font-size: 0.85em;
    letter-spacing: 0.5px;
    border-bottom: 2px solid #e2e8f0;
  }

  .samples-table td {
    padding: 16px;
    border-bottom: 1px solid #e2e8f0;
  }

  .samples-table tr:nth-child(even) {
    background-color: #f8fafc;
  }

  .samples-table tr:hover {
    background-color: #ebf8ff;
  }

  .sample-id {
    font-weight: 600;
    color: #2c5282;
  }

  .source-info,
  .vehicle-info {
    line-height: 1.4;
  }

  .source-type,
  .vehicle-id {
    font-size: 0.9em;
    color: #718096;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .source-name,
  .vehicle-name {
    font-weight: 500;
    color: #2d3748;
  }

  .destination,
  .volume {
    color: #2d3748;
    font-weight: 500;
  }

  .received-date,
  .arrival-time {
    text-align: center;
    line-height: 1.4;
  }

  .date {
    font-weight: 500;
    color: #2d3748;
  }

  .time {
    font-size: 0.9em;
    color: #718096;
  }

  .status-badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .status-passed {
    background-color: #c6f6d5;
    color: #22543d;
  }

  .status-failed {
    background-color: #fed7d7;
    color: #721c24;
  }

  .btn-view {
    padding: 8px 16px;
    background-color: #4299e1;
    color: white;
    text-decoration: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    transition: background-color 0.2s ease;
    display: inline-block;
  }

  .btn-view:hover {
    background-color: #3182ce;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #718096;
  }

  .empty-icon {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
  }

  .empty-text {
    font-size: 1.1rem;
    font-weight: 500;
    margin-bottom: 8px;
    color: #4a5568;
  }

  .empty-subtext {
    font-size: 0.9rem;
  }
</style>

<div class="container">
    <h1>CIP Records by Route</h1>

    <!-- Filter Section -->
    <div class="filter-card">
        <h2 class="section-title">Filter by Route & Vehicle</h2>
        <form method="GET" class="filter-form">
            <div class="form-grid">
                <div class="form-group">
                    <label for="route">Select Route</label>
                    <select id="route" name="route" class="form-select" required>
                        <option value="">Select Route</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="vehicle">Vehicles on that Route</label>
                    <select id="vehicle" name="vehicle" class="form-select" required>
                        <option value="">Select Vehicle</option>
                    </select>
                </div>

                <div class="form-group">
                    <div class="form-actions">
                        <button type="submit" class="apply-filter">Apply Filter</button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- CIP Records Table -->
    <div class="samples-section">
        <div class="section-header">
            <h2>CIP Records</h2>
        </div>

            <table class="samples-table">
                <thead>
                    <tr>
                        <th>Vehicle Number</th>
                        <th>Certificate Number</th>
                        <th>Wash Type</th>
                        <th>Start Time</th>
                        <th>Finish Time</th>
                        <th>Expiry Date</th>
                        <th>Final Rinse</th>
                        <th>Conductivity (mS)</th>
                        <th>Result</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
    </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const routeSelect = document.getElementById("route");
  const vehicleSelect = document.getElementById("vehicle");

  fetch("/graphql/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      query: `
        query {
          allRoutes {
            id
            name
          }
        }
      `,
    }),
  })
    .then(res => res.json())
    .then(res => {
      const routes = res.data.allRoutes;
      routes.forEach(route => {
        const option = document.createElement("option");
        option.value = route.id;
        option.textContent = route.name;
        routeSelect.appendChild(option);
      });
    })
    .catch(err => console.error("Error fetching routes:", err));

  routeSelect.addEventListener("change", (e) => {
    const routeId = e.target.value;
    vehicleSelect.innerHTML = '<option value="">Select Vehicle</option>';

    if (!routeId) return;

    fetch("/graphql/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        query: `
          query ($routeId: Int!) {
            vehiclesByRoute(routeId: $routeId) {
              id
              vehicleId
              name
            }
          }
        `,
        variables: { routeId: parseInt(routeId) }
      }),
    })
      .then(res => res.json())
      .then(res => {
        const vehicles = res.data.vehiclesByRoute;
        vehicles.forEach(vehicle => {
          const option = document.createElement("option");
          option.value = vehicle.id;
          option.textContent = `${vehicle.name} - ${vehicle.vehicleId}`;
          vehicleSelect.appendChild(option);
        });
      })
      .catch(err => console.error("Error fetching vehicles:", err));
  });
});

// CIP Records Table
const cipTableBody = document.querySelector(".samples-table tbody");
const vehicleSelect = document.getElementById("vehicle");

// Listen to vehicle selection changes
vehicleSelect.addEventListener("change", (e) => {
  const vehicleId = e.target.value;

  // Clear previous table rows
  cipTableBody.innerHTML = "";

  if (!vehicleId) return;

  // Fetch CIP records for selected vehicle
  fetch("/graphql/", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      query: `
        query ($vehicleId: Int!) {
          cipRecordsByVehicle(vehicleId: $vehicleId) {
            id
            certificateNo
            washType
            startedAt
            finishedAt
            expiryAt
            finalRinseCondMs
            passed
            vehicle {
              id
              name
              vehicleId
            }
          }
        }
      `,
      variables: { vehicleId: parseInt(vehicleId) },
    }),
  })
    .then(res => res.json())
    .then(res => {
      const records = res.data.cipRecordsByVehicle;

      if (!records.length) {
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="10" style="text-align:center;">No CIP Records found</td>`;
        cipTableBody.appendChild(row);
        return;
      }

      function formatDateTimeUTC(dateString) {
        if (!dateString) return "";

        const dt = new Date(dateString);

        // Format date as DD-MM-YYYY
        const day = ("0" + dt.getUTCDate()).slice(-2);
        const month = ("0" + (dt.getUTCMonth() + 1)).slice(-2);
        const year = dt.getUTCFullYear();
        const datePart = `${day}-${month}-${year}`;

        // Format time in AM/PM 12-hour format
        let hours = dt.getUTCHours();
        const minutes = ("0" + dt.getUTCMinutes()).slice(-2);
        const ampm = hours >= 12 ? "PM" : "AM";
        hours = hours % 12;
        hours = hours ? hours : 12; // the hour '0' should be '12'
        const timePart = `${hours}:${minutes} ${ampm}`;

        // Return with <br> between date and time for separate lines
        return `${datePart}<br>${timePart}`;
        }

      records.forEach(record => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${record.vehicle.name} - ${record.vehicle.vehicleId}</td>
          <td>${record.certificateNo || ""}</td>
          <td>${record.washType || ""}</td>
          <td>${formatDateTimeUTC(record.startedAt)}</td>
          <td>${formatDateTimeUTC(record.finishedAt)}</td>
          <td>${(() => {
            const dt = new Date(record.expiryAt);
            return ("0" + dt.getUTCDate()).slice(-2) + "-" + ("0" + (dt.getUTCMonth() + 1)).slice(-2) + "-" + dt.getUTCFullYear();
            })()}
          </td>
          <td>${record.finalRinseCondMs || ""}</td>
          <td>${record.finalRinseCondMs || ""}</td>
          <td>${record.passed ? "Passed" : "Failed"}</td>
          <td>
            <button class="btn btn-sm btn-primary">View</button>
          </td>
        `;
        cipTableBody.appendChild(row);
      });
    })
    .catch(err => console.error("Error fetching CIP records:", err));
});


</script>
{% endblock %}